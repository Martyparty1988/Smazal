<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Najdi smažák v10.0 - Neon Overdrive</title>
    
    <!-- PWA Icon and Manifest Generator -->
    <script>
        (function() {
            function drawIcon(size) {
                const canvas = document.createElement('canvas'); canvas.width = size; canvas.height = size; const ctx = canvas.getContext('2d'); const scale = size / 512; ctx.fillStyle = '#0a192f'; ctx.fillRect(0, 0, size, size); ctx.save(); ctx.translate(size / 2, size / 2); const bagWidth = 280 * scale; const bagHeight = 320 * scale; ctx.beginPath(); ctx.moveTo(-bagWidth / 2, -bagHeight / 2 + 50 * scale); ctx.lineTo(-bagWidth / 2, bagHeight / 2); ctx.quadraticCurveTo(0, bagHeight / 2 + 40 * scale, bagWidth / 2, bagHeight / 2); ctx.lineTo(bagWidth / 2, -bagHeight / 2 + 50 * scale); ctx.closePath(); ctx.fillStyle = 'rgba(230, 240, 255, 0.15)'; ctx.strokeStyle = 'rgba(150, 180, 220, 0.4)'; ctx.lineWidth = 6 * scale; ctx.fill(); ctx.stroke(); ctx.beginPath(); ctx.moveTo(-bagWidth / 2 * 0.8, bagHeight / 2); ctx.quadraticCurveTo(-bagWidth / 2 * 0.5, bagHeight / 2 - 100 * scale, 0, bagHeight / 2 - 50 * scale); ctx.quadraticCurveTo(bagWidth / 2 * 0.5, bagHeight / 2 - 100 * scale, bagWidth / 2 * 0.8, bagHeight / 2); ctx.closePath(); ctx.fillStyle = 'rgba(255, 255, 255, 0.8)'; ctx.shadowColor = 'rgba(255, 255, 255, 0.7)'; ctx.shadowBlur = 20 * scale; ctx.fill(); ctx.shadowBlur = 0; ctx.fillStyle = 'rgba(20, 30, 50, 0.5)'; ctx.fillRect(-bagWidth/2 - 10*scale, -bagHeight/2 + 40*scale, bagWidth + 20*scale, 20*scale); ctx.strokeStyle = 'rgba(150, 180, 220, 0.6)'; ctx.strokeRect(-bagWidth/2 - 10*scale, -bagHeight/2 + 40*scale, bagWidth + 20*scale, 20*scale); ctx.beginPath(); ctx.moveTo(-40 * scale, -bagHeight / 2 + 40 * scale); ctx.quadraticCurveTo(0, -bagHeight/2 - 30 * scale, 40 * scale, -bagHeight/2 + 40 * scale); ctx.strokeStyle = '#facc15'; ctx.lineWidth = 10 * scale; ctx.stroke(); ctx.restore(); return canvas.toDataURL('image/png');
            }
            const icon192 = drawIcon(192), icon512 = drawIcon(512), favicon = drawIcon(32), themeColor = '#0a192f'; const manifest = { name: "Najdi smažák v10.0", short_name: "Smažák", start_url: ".", display: "standalone", background_color: themeColor, theme_color: themeColor, icons: [{ src: icon192, type: "image/png", sizes: "192x192" }, { src: icon512, type: "image/png", sizes: "512x512" }] }; const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' }); const manifestURL = URL.createObjectURL(blob); document.head.insertAdjacentHTML('beforeend', `<link rel="icon" href="${favicon}"><link rel="apple-touch-icon" href="${icon192}"><link rel="manifest" href="${manifestURL}"><meta name="theme-color" content="${themeColor}"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">`);
        })();
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #0a192f; --accent-cyan: #07f5f5; --accent-purple: #c355f7; --accent-yellow: #fde047;
            --accent-red: #f472b6; --accent-green: #4ade80; --text-primary: #e2e8f0; --text-secondary: #94a3b8;
            --glass-bg: rgba(28, 37, 61, 0.65); --glass-border: rgba(100, 116, 139, 0.3);
            --glow-cyan: rgba(7, 245, 245, 0.5); --glow-purple: rgba(195, 85, 247, 0.55);
            --safe-area-top: env(safe-area-inset-top, 0px); --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-left: env(safe-area-inset-left, 0px); --safe-area-right: env(safe-area-inset-right, 0px);
        }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; touch-action: none; -webkit-tap-highlight-color: transparent; background-color: var(--bg-color); color: var(--text-primary); font-family: 'Share Tech Mono', monospace; }
        #webgl-canvas { position: fixed; top: 0; left: 0; z-index: 0; }
        #root { position: fixed; inset: 0; z-index: 1; display: flex; align-items: center; justify-content: center; }
        #stage { position: relative; width: 360px; height: 640px; transform-origin: center center; overflow: hidden; display: flex; flex-direction: column; padding: var(--safe-area-top) var(--safe-area-right) var(--safe-area-bottom) var(--safe-area-left); }
        /* --- DESIGN UPDATE: Vignette & Glitch Effect --- */
        #stage::before { content: ''; position: absolute; inset: 0; z-index: 99; pointer-events: none; box-shadow: inset 0 0 100px 20px rgba(10, 25, 47, 0.8); }
        #stage::after { content: ''; position: absolute; inset: 0; z-index: 100; pointer-events: none; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); background-size: 100% 4px, 3px 100%; animation: flicker 0.15s infinite; }
        @keyframes flicker { 0% { opacity: 0.2; } 20% { opacity: 0.8; } 40% { opacity: 0.3; } 60% { opacity: 0.9; } 80% { opacity: 0.2; } 100% { opacity: 0.8; } }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .hidden { display: none !important; }
        .scene, .overlay { position: absolute; inset: 0; display: flex; flex-direction: column; }
        .overlay { background: rgba(10, 25, 47, 0.7); backdrop-filter: blur(10px); z-index: 50; }
        #hud { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; padding: 12px; z-index: 10; gap: 8px; }
        .threat-gauge { background: var(--glass-bg); border: 1px solid var(--glass-border); height: 12px; border-radius: 99px; padding: 2px; }
        .threat-gauge > i { display: block; height: 100%; border-radius: 99px; background: linear-gradient(90deg, var(--accent-green), var(--accent-yellow), var(--accent-red)); background-size: 400% 100%; transition: width 0.5s cubic-bezier(0.25, 1, 0.5, 1); will-change: width; }
        .hud-status { text-shadow: 0 0 5px var(--glow-cyan), 0 0 15px var(--glow-cyan); }
        .hud-pill { background: var(--glass-bg); border: 1px solid var(--glass-border); padding: 4px 8px; border-radius: 99px; font-size: 12px; text-shadow: 0 0 5px var(--glow-cyan); transition: text-shadow 0.3s, color 0.3s, background-color 0.3s; }
        .hud-pill.highlight { color: var(--accent-yellow); text-shadow: 0 0 10px var(--accent-yellow); background-color: rgba(253, 224, 71, 0.1); }
        #stat-bpm-pill { cursor: pointer; user-select: none; }
        #scanner { position: relative; width: 280px; height: 280px; border-radius: 999px; margin: auto; display: flex; align-items: center; justify-content: center; border: 3px solid rgba(7, 245, 245, 0.2); box-shadow: 0 0 40px var(--glow-cyan) inset, 0 0 10px var(--glow-cyan); animation: pulse 4s infinite ease-in-out; }
        @keyframes pulse { 50% { box-shadow: 0 0 50px var(--glow-cyan) inset, 0 0 20px var(--glow-cyan); } }
        .scanner-ring { position: absolute; inset: -15px; border: 2px dashed var(--accent-cyan); border-radius: 999px; opacity: 0.6; animation: rotate 30s linear infinite; will-change: transform; }
        .scanner-line { position: absolute; left: 5%; width: 90%; height: 3px; background: linear-gradient(90deg, transparent, var(--accent-cyan), transparent); box-shadow: 0 0 15px 3px var(--glow-cyan); animation: scan 4s ease-in-out infinite; will-change: top; border-radius: 3px; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes scan { 0%, 100% { top: 10%; } 50% { top: 90%; } }
        #actions { padding: 20px; z-index: 10; }
        .btn { font-family: 'Orbitron', sans-serif; font-weight: 700; padding: 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2); color: var(--text-primary); text-transform: uppercase; letter-spacing: 1.5px; background: linear-gradient(45deg, rgba(7, 245, 245, 0.8), rgba(195, 85, 247, 0.8)); box-shadow: 0 0 20px 2px var(--glow-cyan), inset 0 0 5px rgba(255,255,255,0.5); transition: all 0.2s ease; text-shadow: 0 1px 2px rgba(0,0,0,0.4); }
        .btn:hover:not(:disabled) { box-shadow: 0 0 30px 5px var(--glow-purple), inset 0 0 10px rgba(255,255,255,0.5); transform: translateY(-2px); }
        .btn:active:not(:disabled) { transform: scale(0.97) translateY(1px); }
        .btn:disabled { filter: grayscale(80%) brightness(0.7); opacity: 0.6; cursor: not-allowed; box-shadow: none; }
        #toast-container { position: absolute; bottom: 100px; left: 20px; right: 20px; display: flex; flex-direction: column-reverse; gap: 8px; z-index: 40; pointer-events: none; }
        /* --- FIX: Toast Duration --- */
        .toast { background: var(--glass-bg); backdrop-filter: blur(10px); padding: 10px 14px; border-radius: 12px; font-size: 13px; border-left: 4px solid var(--accent-cyan); animation: toast-in 0.4s ease-out, toast-out 0.4s ease-in 4.6s; opacity: 0; }
        @keyframes toast-in { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes toast-out { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(-20px); } }
        .panel { margin: auto; width: 90%; background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 24px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); padding: 24px; text-align: center; }
        .scan-active { animation: screen-shake 0.5s, chromatic-aberration 0.5s; }
        @keyframes screen-shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); } 20%, 40%, 60%, 80% { transform: translateX(2px); } }
        @keyframes chromatic-aberration { 0%, 100% { text-shadow: none; filter: none; } 50% { text-shadow: 2px 2px 0 var(--accent-red), -2px -2px 0 var(--accent-cyan); filter: blur(0.5px); } }
        
        #subject-card { position: absolute; top: 15px; left: 15px; z-index: 20; background: var(--glass-bg); border: 1px solid var(--glass-border); padding: 8px 12px; border-radius: 12px; backdrop-filter: blur(5px); cursor: pointer; transition: all 0.2s ease; transform: translateX(-150%); }
        #subject-card.visible { transform: translateX(0); }
        #subject-card:hover { border-color: var(--accent-cyan); box-shadow: 0 0 15px var(--glow-cyan); }
        #subject-card-name { font-family: 'Orbitron', sans-serif; font-weight: 700; color: var(--accent-yellow); }
        #subject-card-sub { font-size: 10px; color: var(--text-secondary); }
        #paranoia-ticker { position: absolute; top: 80px; left: 0; right: 0; z-index: 20; text-align: center; font-size: 14px; font-weight: bold; color: var(--accent-red); text-shadow: 0 0 10px var(--accent-red); opacity: 0; transition: opacity 0.5s; pointer-events: none; }
        #paranoia-ticker.visible { opacity: 1; }
        .timing-bar { position: relative; width: 100%; height: 10px; background-color: #1e293b; border-radius: 5px; overflow: hidden; }
        .timing-bar-target { position: absolute; top: 0; height: 100%; background-color: rgba(74, 222, 128, 0.5); }
        .timing-bar-marker { position: absolute; top: 0; height: 100%; width: 4px; background-color: var(--accent-cyan); box-shadow: 0 0 5px var(--accent-cyan); }
        
        #varna-icon-button { position: absolute; bottom: 110px; right: 20px; z-index: 20; width: 64px; height: 64px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 99px; backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; }
        #varna-icon-button:hover { border-color: var(--accent-purple); box-shadow: 0 0 15px var(--glow-purple); transform: scale(1.05); }
        #varna-icon-button svg { width: 32px; height: 32px; fill: var(--accent-purple); transition: all 0.2s; }
        #varna-icon-button:hover svg { fill: var(--text-primary); filter: drop-shadow(0 0 5px var(--accent-purple)); }

        #scene-varna, #scene-upgrades { justify-content: center; align-items: center; }
        #varna-purity-bar { width: 100%; height: 20px; background-color: #1e293b; border-radius: 10px; margin: 16px 0; padding: 3px; }
        #varna-purity-fill { height: 100%; background: linear-gradient(90deg, var(--accent-red), var(--accent-yellow), var(--accent-green)); border-radius: 7px; transition: width 0.5s; }
        .upgrade-item { padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; margin-bottom: 8px; text-align: left; }
        .upgrade-item.unlocked { border-color: var(--accent-green); background-color: rgba(74, 222, 128, 0.1); }
        .upgrade-item h4 { color: var(--accent-yellow); }

        @media (prefers-reduced-motion: reduce) {
            .scanner-ring, .scanner-line, #stage::after, .scan-active, .pulse { animation: none; }
            .toast { animation: none; opacity: 1; }
            .threat-gauge > i { transition: none; }
        }
    </style>
</head>
<body>
    <canvas id="webgl-canvas"></canvas>
    <div id="root" role="application">
        <div id="stage">
            <div id="scene-game" class="scene hidden">
                <header id="hud" aria-label="Herní statistiky">
                    <div class="threat-gauge"><i id="threat-gauge-fill"></i></div>
                    <div class="text-center">
                        <div id="hud-status" class="font-orbitron font-bold text-lg text-cyan-300 hud-status" aria-live="polite"></div>
                        <div id="hud-subtext" class="text-xs text-slate-400"></div>
                    </div>
                    <div class="flex items-center justify-end gap-2">
                        <div id="stat-bpm-pill" class="hud-pill">BPM <b id="stat-bpm"></b></div>
                        <div class="hud-pill">RISK <b id="stat-risk"></b></div>
                    </div>
                </header>
                
                <main class="flex-1 flex items-center justify-center relative">
                    <div id="subject-card"><div id="subject-card-name"></div><div id="subject-card-sub">Zobrazit kartu</div></div>
                    <div id="paranoia-ticker"></div>
                    <div id="scanner" role="button" aria-label="Skenovací oblast"><div class="scanner-ring"></div><div class="scanner-line"></div><div class="font-orbitron text-2xl font-black text-cyan-300 text-center" style="text-shadow: 0 0 15px var(--glow-cyan);">NAJDI<br>SMAŽÁK</div></div>
                    <div id="varna-icon-button" aria-label="Uvařit dávku">
                        <svg viewBox="0 0 24 24"><path d="M19.87 11.13C19.67 10.29 19.06 9.63 18.2 9.33L14.67 8C15.3 7.13 15.5 6 15.2 4.91C14.79 3.4 13.27 2.47 11.75 2.89C10.23 3.3 9.3 4.82 9.7 6.34C9.9 7.13 10.45 7.79 11.14 8.15L11.33 8.25L7.8 9.33C6.94 9.63 6.33 10.29 6.13 11.13L3 22H21L19.87 11.13M12 20C10.34 20 9 18.66 9 17C9 15.34 10.34 14 12 14C13.66 14 15 15.34 15 17C15 18.66 13.66 20 12 20Z"></path></svg>
                    </div>
                </main>

                <footer id="actions"><button id="scan-button" class="btn w-full"></button></footer>
            </div>
            
            <div id="scene-menu" class="scene items-center justify-center"><div class="panel"><h1 class="font-orbitron text-4xl font-black text-cyan-300 mb-2" style="text-shadow: 0 0 15px var(--glow-cyan);">NAJDI SMAŽÁK</h1><p class="text-slate-400 mb-6">v10.0 - Neon Overdrive</p><div class="flex flex-col gap-3"><button id="play-button" class="btn w-full">HRÁT</button><button id="upgrades-button" class="btn w-full bg-yellow-400/90" style="background: linear-gradient(45deg, #fde047, #f59e0b); box-shadow: 0 0 20px rgba(250, 204, 21, 0.45);">VYLEPŠENÍ</button></div></div></div>
            
            <div id="overlay" class="overlay hidden items-center justify-center" role="dialog" aria-modal="true"><div class="panel"><h2 id="overlay-title" class="font-orbitron text-2xl font-bold text-cyan-300 mb-4"></h2><div id="overlay-content" class="panel-content text-slate-300 mb-6"></div><div class="flex flex-col gap-3"><button id="back-button" class="btn w-full bg-gray-500/80" style="background: #4b5563; box-shadow: none;"></button></div></div></div>

            <div id="scene-varna" class="scene hidden items-center justify-center">
                <div class="panel">
                    <h2 class="font-orbitron text-2xl font-bold text-cyan-300 mb-2">PROCES VAŘENÍ</h2>
                    <p class="text-slate-400 text-sm">Čistota dávky: <b id="varna-purity-label">100%</b></p>
                    <div id="varna-purity-bar"><div id="varna-purity-fill" style="width: 100%;"></div></div>
                    <p id="varna-instruction" class="my-4 font-bold text-lg text-yellow-300"></p>
                    <div id="varna-timing-bar" class="timing-bar h-6 my-4"><div class="timing-bar-target"></div><div class="timing-bar-marker"></div></div>
                    <button id="varna-action-button" class="btn w-full hidden">START</button>
                </div>
            </div>

            <div id="scene-upgrades" class="scene hidden items-center justify-center">
                <div class="panel">
                    <h2 class="font-orbitron text-2xl font-bold text-cyan-300 mb-2">VYLEPŠENÍ VARNY</h2>
                    <p class="mb-4">Nasbírané součástky: <b id="components-label">0</b></p>
                    <div id="upgrades-list" class="max-h-64 overflow-y-auto"></div>
                    <button id="upgrades-back-button" class="btn w-full bg-gray-500/80 mt-4" style="background: #4b5563; box-shadow: none;">ZPĚT DO MENU</button>
                </div>
            </div>
            
            <div id="toast-container" aria-live="assertive" aria-atomic="true"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA ---
            const DATA = {
                subjects: [
                    {id:'slehac',name:'Šlehař Delta-Piko',profile:'Původ: Uliční varna v Žižkově.<br>Schopnosti: Pozná feťáka na 200 metrů.<br>Slabiny: Bojí se holubů.',toastPhrases:['Čistota nad 80 %, leť.','Filtr čistý. Nezakecej.','Míchám to jak boží prst.','Teplota drží, nepřepal.','Vzorek stabilní. Plynule.'],logPhrases:['Vařím dávku, drž se','Šlehám vrstvičku I','Dealer hlásí, že zboží jede','Piko čistota 78 %, dobrý','Připravuju stříkačku','Váha ukazuje přesně.','Filtruju přes cigaretu.']},
                    {id:'hulic',name:'Hulič Zubatá Žárovka',profile:'Původ: Skleník za panelákem.<br>Schopnosti: Umí ubalit brko i poslepu.<br>Slabiny: Neustále se směje vlastním vtipům.',toastPhrases:['Táhne to. Drž linku.','Popel si sedá, klid.','Sklo čistý – respekt.','Seshni to na špičku.','Vlhkej kašel? Voda, kámo.'],logPhrases:['Přepaluju sklo','Už to bublá, kámo','Mám totální červený oči','Kde je zapalovač?','Tohle je silnej model','Mám vlčí hlad.','Kde mám drtičku?']},
                    {id:'cichac',name:'Čichač Trubek Omega',profile:'Původ: Kanály pod hlavním nádražím.<br>Schopnosti: Pozná značku ředidla po čichu.<br>Slabiny: Často mluví s odpadkovými koši.',toastPhrases:['Hadr ready. Film běží.','Vdechni – nepřeháněj.','Profil drží, barvičky.','Víčko těsní, klídek.','Kanystr mlčí. Zatím.'],logPhrases:['Čichám toluen z hadru','Tohle lepidlo je top','Mozek mi odchází na výlet','Kde je ta igelitka?','Všechno se točí','Testuju novej druh ředidla.','Ten igeliťák už má díru.']},
                    {id:'domingo',name:'Domingo ze Smíchova',profile:'Původ: Lavička na Andělu.<br>Schopnosti: Dokáže prodat cokoliv komukoliv. Kvalita zboží je... proměnlivá.<br>Slabiny: Občas má tak dobrej perník, že tě vystřelí z papučí.',toastPhrases:['Předávka v tichu.','Kamera za rohem – bacha.','Balíček nenápadnej.','Čas jsou prachy.','Stín mě kryje.'],logPhrases:['Mám čerstvej matroš, chceš?','Dneska akce, dva za cenu jednoho.','Bacha, za rohem stojej fízlové.','Platba jen v hotovosti, kámo.','Tohle je čistý, přísahám.','Nekoukej tak nápadně.']},
                    {id:'klara',name:'Kyselina Klára',profile:'Původ: Nonstop mejdan v Crossu.<br>Schopnosti: Vidí zvuky a slyší barvy.<br>Slabiny: Občas se zasekne a 10 minut kouká na vlastní ruku.',toastPhrases:['Fraktály se sbíhají...','Stěny zase dýchají.','Vesmír mi něco šeptá.','Ten koberec se hýbe.','Čas je jen iluze, kámo.'],logPhrases:['Papír se rozpouští.','Už to najíždí.','Mluvil na mě automat na kafe.','Všechno je propojený.','Ztrácím se v hudbě.','Tohle je jinej level vědomí.']},
                    {id:'nikotin',name:'Nádražák Nikotin',profile:'Původ: Lavička před Hlavákem.<br>Schopnosti: Dokáže vyžebrat dvacku i od sochy.<br>Slabiny: Bez cigarety má absťák a třesou se mu ruce.',toastPhrases:['Nemáš oheň?','Hele, dvacku... na vlak.','Už se mi klepou ruce.','Potřebuju nutně cígo.','Jen jedno práska...'],logPhrases:['Dneska ještě ani čára.','Kde seženu prachy?','Ten absťák mě zabije.','Potřebuju dávku, hned.','Všechno mě svrbí.','Třesu se jak ratlík.']}
                ],
                threatLevels: [{width:25},{width:50},{width:75},{width:100}],
                scanStates: [{status:'KALIBRACE',subtext:'Míchám to s toluenem...'},{status:'ANALÝZA',subtext:'Dobrý matroš...'},{status:'HOTOVO',subtext:'Čistota 98%, kámo!'}],
                labUpgrades: {
                    filtration: { name: 'Lepší filtrace', description: 'Zpomaluje pasivní nárůst ohrožení.', cost: 5, unlocked: false },
                    stabilizer: { name: 'Stabilizátor stíhy', description: 'Zpomaluje frekvenci paranoidních hlášek.', cost: 8, unlocked: false },
                    cooker: { name: 'Turbo vařič', description: 'Zvětšuje zelenou zónu při vaření.', cost: 3, unlocked: false }
                },
                cookSteps: [
                    { instruction: 'Přidej louh...', speed: 1.5, targetWidth: 40 },
                    { instruction: 'Zahřej na 90°C', speed: 2.0, targetWidth: 30 },
                    { instruction: 'Filtruj přes kafe', speed: 2.5, targetWidth: 25 },
                    { instruction: 'Krystalizuj...', speed: 3.0, targetWidth: 20 }
                ],
                paranoiaToasts: {
                    mild: ["Ticho… slyšíš to?","To nebyl vítr.","Někdo tu byl.","Zhaslo to samo?","Stín u dveří zmizel.","Ta kamera se pohnula.","Notifikace bez odesílatele.","Zámek cvakl. Dvakrát.","Okno pootevřené. Kdo?","Někdo mi dýchá na krk.","Kroky na chodbě.","Signál kolísá… proč?","Pes štěká. Jen jednou.","Svědí mě záda. Instinkt.","GPS skočila o 3 metry.","Zrcadlo je zamlžené. Ne já.","Zpráva smazána sama.","Už tu dávno nejsi sám."],
                    alert: ["Někdo mě sleduje.","Jsou za dveřma!","Zhasni. Hned.","Už jdou…","Světla blikají. Maják?","Viděl jsi ten stín?","Tři klepnutí na okno.","Siréna v dálce. Blíží se.","Dveře dýchají.","Kamera se směje.","Šepot ze zásuvky.","Slyšíš kroky nad námi.","Wi-Fi má cizí jméno.","Volá neznámý. Bez čísla.","Zámek drží… zatím.","Někdo stojí za záclonou.","Nedívej se ven.","Vypni mobil. Teď."],
                    critical: ["Utíkej. Teď hned.","Svítí na nás modro-červeně.","Dveře se nehýbou. Oni jo.","Je jich víc, než si myslíš.","Zhasli nám jméno.","Okno šeptá tvoje číslo.","Vlezli do zámku.","Za tebou. Neotáčej se.","Neptej se. Dýchej tiše.","Mají klíč. Náš klíč.","Výtah se zastavil u nás.","Kroky se dělí. Dva směry.","Sirenám došel vzduch.","Signál: nulový. Záměrně.","Zvonek bez prstu.","Nekoukej do kamery.","Dveře poddávají. Počítám do tří.","Poslední světlo právě mrklo."]
                }
            };

            class InteractiveBackground {
                constructor(container) { this.container = container; this.scene = new THREE.Scene(); this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000); this.renderer = new THREE.WebGLRenderer({ canvas: this.container, alpha: true }); this.objects = []; this.mouse = new THREE.Vector2(-100, -100); this.init(); }
                init() { this.renderer.setSize(window.innerWidth, window.innerHeight); this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); this.camera.position.z = 5; this.scene.fog = new THREE.FogExp2(0x0a192f, 0.15); const materials = [ new THREE.MeshStandardMaterial({ color: 0xe2e8f0, roughness: 0.8, metalness: 0.1 }), new THREE.MeshStandardMaterial({ color: 0x00f6ff, emissive: 0x00f6ff, emissiveIntensity: 0.5, roughness: 0.2, metalness: 0.5 }), new THREE.MeshStandardMaterial({ color: 0x94a3b8, roughness: 0.5, metalness: 0.8 }), new THREE.MeshStandardMaterial({ color: 0xfacc15, emissive: 0xfacc15, emissiveIntensity: 0.3, roughness: 0.5, metalness: 0.1 }), new THREE.MeshStandardMaterial({ color: 0xffffff, transparent: true, opacity: 0.2, roughness: 0.1, metalness: 0 }) ]; for (let i = 0; i < 50; i++) { let obj; const type = Math.random(); if (type < 0.33) { obj = new THREE.Group(); const body = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 0.8, 8), materials[0]); const liquid = new THREE.Mesh(new THREE.CylinderGeometry(0.04, 0.04, 0.5, 8), materials[1]); liquid.position.y = -0.15; const needle = new THREE.Mesh(new THREE.CylinderGeometry(0.01, 0.01, 0.4, 8), materials[2]); needle.position.y = -0.6; obj.add(body, liquid, needle); } else if (type < 0.66) { obj = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 0.05, 16), materials[3]); } else { obj = new THREE.Mesh(new THREE.PlaneGeometry(0.5, 0.6), materials[4]); } obj.position.set((Math.random() - 0.5) * 10, (Math.random() - 0.5) * 10, (Math.random() - 0.5) * 10); obj.rotation.set(Math.random() * Math.PI, Math.random() * Math.PI, Math.random() * Math.PI); obj.userData.rotationSpeed = new THREE.Vector3(Math.random() * 0.2 - 0.1, Math.random() * 0.2 - 0.1, Math.random() * 0.2 - 0.1); this.scene.add(obj); this.objects.push(obj); } const ambientLight = new THREE.AmbientLight(0x404040, 2); this.scene.add(ambientLight); const pointLight = new THREE.PointLight(0x00f6ff, 1, 100); pointLight.position.set(0, 0, 10); this.scene.add(pointLight); window.addEventListener('resize', this.onWindowResize.bind(this)); window.addEventListener('mousemove', this.onMouseMove.bind(this)); this.animate(); }
                onWindowResize() { this.camera.aspect = window.innerWidth / window.innerHeight; this.camera.updateProjectionMatrix(); this.renderer.setSize(window.innerWidth, window.innerHeight); }
                onMouseMove(event) { this.mouse.x = (event.clientX / window.innerWidth) * 2 - 1; this.mouse.y = -(event.clientY / window.innerHeight) * 2 + 1; }
                animate() { requestAnimationFrame(this.animate.bind(this)); this.objects.forEach(obj => { obj.rotation.x += obj.userData.rotationSpeed.x * 0.1; obj.rotation.y += obj.userData.rotationSpeed.y * 0.1; obj.rotation.z += obj.userData.rotationSpeed.z * 0.1; }); this.camera.position.x += (this.mouse.x * 0.5 - this.camera.position.x) * 0.02; this.camera.position.y += (this.mouse.y * 0.5 - this.camera.position.y) * 0.02; this.camera.lookAt(this.scene.position); this.renderer.render(this.scene, this.camera); }
            }
            
            class SmazakGame {
                constructor() {
                    this.state = { gameState: 'MENU', isScanning: false, threatIndex: 0, currentSubject: null, timers: { threat: null, scanStep: null, paranoia: null }, lab: { components: 0, upgrades: JSON.parse(localStorage.getItem('smazakUpgrades')) || DATA.labUpgrades }, varna: { active: false, step: 0, purity: 100, animationFrame: null, position: 0, speed: 1, direction: 1 } };
                    this.elements = { stage: document.getElementById('stage'), scenes: { game: document.getElementById('scene-game'), menu: document.getElementById('scene-menu'), varna: document.getElementById('scene-varna'), upgrades: document.getElementById('scene-upgrades') }, overlay: document.getElementById('overlay'), buttons: { play: document.getElementById('play-button'), scan: document.getElementById('scan-button'), back: document.getElementById('back-button'), varnaIcon: document.getElementById('varna-icon-button'), varnaAction: document.getElementById('varna-action-button'), upgrades: document.getElementById('upgrades-button'), upgradesBack: document.getElementById('upgrades-back-button') }, hud: { status: document.getElementById('hud-status'), subtext: document.getElementById('hud-subtext'), bpm: document.getElementById('stat-bpm'), bpmPill: document.getElementById('stat-bpm-pill'), risk: document.getElementById('stat-risk'), threatGauge: document.getElementById('threat-gauge-fill') }, scanner: document.getElementById('scanner'), toastContainer: document.getElementById('toast-container'), overlayElements: { title: document.getElementById('overlay-title'), content: document.getElementById('overlay-content') }, subjectCard: { container: document.getElementById('subject-card'), name: document.getElementById('subject-card-name') }, paranoiaTicker: document.getElementById('paranoia-ticker'), varna: { instruction: document.getElementById('varna-instruction'), purityLabel: document.getElementById('varna-purity-label'), purityFill: document.getElementById('varna-purity-fill'), timingBar: document.getElementById('varna-timing-bar'), target: document.querySelector('#varna-timing-bar .timing-bar-target'), marker: document.querySelector('#varna-timing-bar .timing-bar-marker') }, upgrades: { list: document.getElementById('upgrades-list'), componentsLabel: document.getElementById('components-label') } };
                    this.init();
                }

                init() {
                    this.loadState(); this.scaleStage(); this.setupEventListeners(); this.setGameState('MENU'); new InteractiveBackground(document.getElementById('webgl-canvas'));
                }
                
                randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
                getRandomElement = (arr) => arr[Math.floor(Math.random() * arr.length)];
                vibrate = (pattern) => { if (navigator.vibrate) navigator.vibrate(pattern); };
                scaleStage = () => { const scale = Math.min(window.innerWidth / 360, window.innerHeight / 640); this.elements.stage.style.transform = `scale(${scale})`; };

                saveState() {
                    localStorage.setItem('smazakComponents', this.state.lab.components);
                    localStorage.setItem('smazakUpgrades', JSON.stringify(this.state.lab.upgrades));
                }
                loadState() {
                    this.state.lab.components = parseInt(localStorage.getItem('smazakComponents') || '0');
                    const savedUpgrades = localStorage.getItem('smazakUpgrades');
                    if (savedUpgrades) {
                        this.state.lab.upgrades = JSON.parse(savedUpgrades);
                    } else { 
                        this.state.lab.upgrades = JSON.parse(JSON.stringify(DATA.labUpgrades));
                    }
                }

                setGameState(newState, overlayMode = null) {
                    this.state.gameState = newState;
                    Object.values(this.elements.scenes).forEach(s => s.classList.add('hidden'));
                    this.elements.overlay.classList.add('hidden');
                    switch (newState) {
                        case 'MENU': this.elements.scenes.menu.classList.remove('hidden'); this.stopThreatTimer(); this.stopParanoiaTicker(); break;
                        case 'PLAYING': this.elements.scenes.game.classList.remove('hidden'); this.startThreatTimer(); break;
                        case 'OVERLAY': this.elements.scenes.game.classList.remove('hidden'); this.elements.overlay.classList.remove('hidden'); this.stopThreatTimer(); this.stopParanoiaTicker(); if (overlayMode) this.updateOverlayContent(overlayMode); break;
                        case 'VARNA': this.elements.scenes.varna.classList.remove('hidden'); this.stopThreatTimer(); this.stopParanoiaTicker(); break;
                        case 'UPGRADES': this.elements.scenes.upgrades.classList.remove('hidden'); this.renderUpgrades(); break;
                    }
                }
                
                setupEventListeners() {
                    window.addEventListener('resize', this.scaleStage);
                    this.elements.buttons.play.addEventListener('pointerdown', () => this.startGame());
                    this.elements.buttons.scan.addEventListener('pointerdown', () => this.runScanSequence());
                    this.elements.buttons.back.addEventListener('pointerdown', () => this.setGameState('PLAYING'));
                    this.elements.subjectCard.container.addEventListener('pointerdown', () => this.setGameState('OVERLAY', 'profile'));
                    this.elements.hud.bpmPill.addEventListener('pointerdown', () => { if(this.state.currentSubject) this.toast(this.getRandomElement(this.state.currentSubject.toastPhrases)); });
                    this.elements.buttons.varnaIcon.addEventListener('pointerdown', () => this.startVarnaMinigame());
                    this.elements.buttons.varnaAction.addEventListener('pointerdown', () => this.handleVarnaClick());
                    this.elements.buttons.upgrades.addEventListener('pointerdown', () => this.setGameState('UPGRADES'));
                    this.elements.buttons.upgradesBack.addEventListener('pointerdown', () => this.setGameState('MENU'));
                }

                startGame() {
                    this.setSubject(); this.state.threatIndex = 0; this.updateThreat(0); this.updateStats(); this.setHUD('READY', 'Čekám na lajnu', 'NAJDI NEJBLIŽŠÍHO SMAŽU'); this.setGameState('PLAYING');
                }

                runScanSequence() {
                    if (this.state.isScanning) return;
                    this.state.isScanning = true; this.elements.buttons.scan.disabled = true; this.elements.stage.classList.add('scan-active'); setTimeout(() => this.elements.stage.classList.remove('scan-active'), 500);
                    let step = 0;
                    const sequenceStep = () => {
                        if (step >= DATA.scanStates.length) {
                            this.setHUD('READY', 'Čekám na další lajnu', 'NAJDI NEJBLIŽŠÍHO SMAŽU'); this.elements.buttons.scan.disabled = false; this.state.isScanning = false; this.setSubject(); this.updateThreat(-1); this.toast('Sken hotový.');
                            return;
                        }
                        const scanState = DATA.scanStates[step];
                        this.setHUD(scanState.status, scanState.subtext, scanState.status);
                        this.toast(this.getRandomElement(this.state.currentSubject?.logPhrases || ["..."]));
                        this.updateStats(); step++; this.state.timers.scanStep = setTimeout(sequenceStep, 1500);
                    };
                    sequenceStep();
                }

                updateOverlayContent(mode) {
                    if (mode === 'profile' && this.state.currentSubject) {
                        this.elements.overlayElements.title.textContent = `KARTA: ${this.state.currentSubject.name.toUpperCase()}`;
                        this.elements.overlayElements.content.innerHTML = this.state.currentSubject.profile;
                        this.elements.buttons.back.textContent = 'ZPĚT DO HRY';
                    }
                }
                
                setSubject() { this.state.currentSubject = this.getRandomElement(DATA.subjects); this.elements.subjectCard.name.textContent = this.state.currentSubject.name; this.elements.subjectCard.container.classList.add('visible'); }
                updateThreat(delta) { this.state.threatIndex = Math.max(0, Math.min(DATA.threatLevels.length - 1, this.state.threatIndex + delta)); this.elements.hud.threatGauge.style.width = `${DATA.threatLevels[this.state.threatIndex].width}%`; if (this.state.threatIndex === DATA.threatLevels.length - 1) this.vibrate([80, 40, 80]); }
                updateStats() { const bpm = this.randomInt(70, 180); this.elements.hud.bpm.textContent = bpm; this.elements.hud.risk.textContent = `${this.randomInt(10, 95)}%`; [this.elements.hud.bpmPill, this.elements.hud.risk.parentElement].forEach(el => { el.classList.add('highlight'); setTimeout(() => el.classList.remove('highlight'), 500); }); this.checkParanoia(bpm); }
                setHUD(status, subtext, buttonText) { this.elements.hud.status.textContent = status; this.elements.hud.subtext.textContent = subtext; this.elements.buttons.scan.textContent = buttonText; }
                
                toast(message) { 
                    if (this.elements.toastContainer.children.length >= 4) this.elements.toastContainer.lastElementChild.remove();
                    const toastEl = document.createElement('div');
                    toastEl.className = 'toast';
                    toastEl.textContent = message;
                    this.elements.toastContainer.prepend(toastEl);
                    // --- FIX: Toast Duration ---
                    setTimeout(() => toastEl.remove(), 5000);
                }
                
                checkParanoia(bpm) { if (bpm > 120) { this.startParanoiaTicker(bpm); } else { this.stopParanoiaTicker(); } }
                startParanoiaTicker(bpm) {
                    if (this.state.timers.paranoia) return;
                    this.elements.paranoiaTicker.classList.add('visible');
                    const updateTicker = () => {
                        let level = 'mild';
                        if (bpm > 160) level = 'critical';
                        else if (bpm > 140) level = 'alert';
                        this.elements.paranoiaTicker.textContent = this.getRandomElement(DATA.paranoiaToasts[level]);
                    };
                    updateTicker();
                    let interval = 2000;
                    if (this.state.lab.upgrades.stabilizer.unlocked) interval = 3500;
                    this.state.timers.paranoia = setInterval(updateTicker, interval);
                }
                stopParanoiaTicker() { clearInterval(this.state.timers.paranoia); this.state.timers.paranoia = null; this.elements.paranoiaTicker.classList.remove('visible'); }

                startThreatTimer() { this.stopThreatTimer(); let interval = 8000; if (this.state.lab.upgrades.filtration.unlocked) interval = 12000; if (this.state.currentSubject?.id === 'nikotin') interval /= 2; this.state.timers.threat = setInterval(() => this.updateThreat(1), interval); }
                stopThreatTimer() { clearInterval(this.state.timers.threat); }

                renderUpgrades() {
                    this.elements.upgrades.componentsLabel.textContent = this.state.lab.components;
                    let contentHTML = '';
                    for (const [id, upgrade] of Object.entries(this.state.lab.upgrades)) {
                        const canAfford = this.state.lab.components >= upgrade.cost;
                        contentHTML += `
                            <div class="upgrade-item ${upgrade.unlocked ? 'unlocked' : ''}">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h4 class="font-bold">${upgrade.name} ${upgrade.unlocked ? '(AKTIVNÍ)' : ''}</h4>
                                        <p class="text-xs text-slate-400">${upgrade.description}</p>
                                    </div>
                                    ${!upgrade.unlocked ? `<button class="btn text-xs py-2 px-4" ${!canAfford ? 'disabled' : ''} onclick="game.buyUpgrade('${id}')">KOUPIT (${upgrade.cost})</button>` : ''}
                                </div>
                            </div>`;
                    }
                    this.elements.upgrades.list.innerHTML = contentHTML;
                }
                buyUpgrade(id) {
                    const upgrade = this.state.lab.upgrades[id];
                    if (upgrade && !upgrade.unlocked && this.state.lab.components >= upgrade.cost) {
                        this.state.lab.components -= upgrade.cost;
                        upgrade.unlocked = true;
                        this.toast(`Vylepšení "${upgrade.name}" aktivováno!`);
                        this.vibrate(100);
                        this.saveState();
                        this.renderUpgrades();
                    }
                }

                startVarnaMinigame() { this.state.varna = { ...this.state.varna, active: true, step: 0, purity: 100 }; this.elements.varna.purityFill.style.width = '100%'; this.elements.varna.purityLabel.textContent = '100%'; this.elements.buttons.varnaAction.textContent = 'START'; this.elements.buttons.varnaAction.classList.remove('hidden'); this.elements.varna.instruction.textContent = 'Připrav se na vaření...'; this.setGameState('VARNA'); }
                handleVarnaClick() { const button = this.elements.buttons.varnaAction; if (button.textContent === 'START') { this.runVarnaStep(); } else if (this.state.varna.active) { this.stopVarnaTimingBar(true); } }
                runVarnaStep() { const { step } = this.state.varna; if (step >= DATA.cookSteps.length) { this.endVarnaMinigame(); return; } const currentStep = DATA.cookSteps[step]; this.elements.varna.instruction.textContent = currentStep.instruction; this.elements.buttons.varnaAction.textContent = 'ZASTAVIT'; this.startVarnaTimingBar(currentStep); }
                startVarnaTimingBar(stepConfig) { this.state.varna.position = 0; this.state.varna.direction = 1; this.state.varna.speed = stepConfig.speed; let targetWidth = stepConfig.targetWidth; if (this.state.lab.upgrades.cooker.unlocked) targetWidth += 10; const targetStart = this.randomInt(0, 100 - targetWidth); this.elements.varna.target.style.left = `${targetStart}%`; this.elements.varna.target.style.width = `${targetWidth}%`; const gameLoop = () => { let { position, speed, direction } = this.state.varna; position += speed * direction; if (position > 100 || position < 0) { direction *= -1; position = Math.max(0, Math.min(100, position)); } this.elements.varna.marker.style.left = `${position}%`; this.state.varna.position = position; this.state.varna.direction = direction; this.state.varna.animationFrame = requestAnimationFrame(gameLoop); }; gameLoop(); }
                stopVarnaTimingBar(playerAction) { if (!this.state.varna.active) return; cancelAnimationFrame(this.state.varna.animationFrame); if (playerAction) { const markerPos = this.state.varna.position; const targetStart = parseFloat(this.elements.varna.target.style.left); const targetEnd = targetStart + parseFloat(this.elements.varna.target.style.width); const success = markerPos >= targetStart && markerPos <= targetEnd; let purityChange = 0; if (success) { purityChange = 5; this.toast('Perfektní!'); } else { purityChange = -15; this.toast('Zkaženo!'); } this.state.varna.purity = Math.max(0, this.state.varna.purity + purityChange); this.elements.varna.purityFill.style.width = `${this.state.varna.purity}%`; this.elements.varna.purityLabel.textContent = `${this.state.varna.purity}%`; } this.state.varna.step++; setTimeout(() => this.runVarnaStep(), 1000); }
                endVarnaMinigame() { this.state.varna.active = false; const finalPurity = this.state.varna.purity; let resultText = `Vaření dokončeno! Čistota: ${finalPurity}%. `; let componentsGained = 0; if (finalPurity >= 95) { resultText += 'Mistrovské dílo! +3 součástky.'; componentsGained = 3; } else if (finalPurity >= 75) { resultText += 'Dobrý matroš. +2 součástky.'; componentsGained = 2; } else if (finalPurity > 0) { resultText += 'Je to kouřitelný. +1 součástka.'; componentsGained = 1; } else { resultText += 'Totálně spáleno. Nic.'; } this.state.lab.components += componentsGained; this.saveState(); this.elements.varna.instruction.textContent = resultText; this.elements.buttons.varnaAction.textContent = 'ZPĚT DO HRY'; this.elements.buttons.varnaAction.onclick = () => this.setGameState('PLAYING'); }
            }

            const game = new SmazakGame();
            window.game = game;
        });
    </script>
</body>
</html>