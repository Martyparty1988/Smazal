<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Futuristický UI Skener v9.2 (Optimalizováno)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #020617;
            --panel-bg: rgba(17, 24, 39, 0.6);
            --panel-border: rgba(55, 65, 81, 0.4);
            --accent-primary: #22d3ee;
            --accent-secondary: #f59e0b;
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --glow-primary: rgba(34, 211, 238, 0.4);
            --glow-secondary: rgba(245, 158, 11, 0.5);
            --danger: #ef4444;
            --glow-danger: rgba(239, 68, 68, 0.5);
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-right: env(safe-area-inset-right, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-left: env(safe-area-inset-left, 0px);
            --ease-out-quint: cubic-bezier(0.22, 1, 0.36, 1);
            --ease-in-out-cubic: cubic-bezier(0.65, 0, 0.35, 1);
        }
        html, body {
            position: fixed; width: 100%; height: 100%; overflow: hidden;
            overscroll-behavior: none; font-family: 'Roboto Mono', monospace;
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at 10% 10%, rgba(34, 211, 238, 0.1) 0%, transparent 30%),
                              radial-gradient(circle at 90% 80%, rgba(168, 85, 247, 0.1) 0%, transparent 40%);
            color: var(--text-primary); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        }
        main#scroll-container {
            width: 100%; height: 100vh; height: 100dvh; overflow-y: auto;
            -webkit-overflow-scrolling: touch; position: relative;
        }
        .content-wrapper {
            padding: calc(var(--safe-area-top) + 1.5rem) calc(var(--safe-area-right) + 1.5rem) calc(var(--safe-area-bottom) + 3rem) calc(var(--safe-area-left) + 1.5rem);
        }
        h3, .font-orbitron { font-family: 'Orbitron', sans-serif; text-shadow: 0 0 10px var(--glow-primary); color: var(--accent-primary); }
        
        .glass-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--panel-border);
            border-radius: 24px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            transition: transform 0.4s var(--ease-out-quint), box-shadow 0.4s var(--ease-out-quint);
        }
        .glass-panel:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.4);
        }

        #radar-display {
            background: radial-gradient(circle, rgba(17, 24, 39, 0.5) 0%, transparent 70%);
            border-radius: 50%; position: relative;
            border: 1px solid var(--panel-border);
            box-shadow: inset 0 0 50px rgba(2, 6, 23, 0.8);
        }
        .radar-line {
            position: absolute; top: 0; left: 50%;
            width: 1px; height: 50%;
            background: linear-gradient(to bottom, var(--accent-primary), transparent);
            transform-origin: bottom center;
            animation: radar-sweep 4s linear infinite;
        }
        @keyframes radar-sweep { to { transform: rotate(360deg); } }
        
        #scanner-status {
            color: var(--text-primary); text-shadow: 0 0 15px var(--glow-primary);
            font-weight: 700; letter-spacing: 0.05em;
        }
        #scanner-subtext {
            color: var(--text-secondary); text-shadow: none; letter-spacing: 0.05em; margin-top: 0.5rem;
        }
        
        .blip {
            position: absolute; border-radius: 50%;
            background-color: var(--accent-secondary);
            box-shadow: 0 0 15px 4px var(--glow-secondary);
            animation: blip-pulse 3.5s infinite alternate var(--ease-in-out-cubic); opacity: 0;
        }
        @keyframes blip-pulse {
            0%, 100% { opacity: 0; transform: scale(0.4); }
            50% { opacity: 1; transform: scale(1.1); }
            75% { transform: scale(0.9); }
        }
        
        .btn {
            border-radius: 9999px; font-weight: 500;
            transition: transform 0.3s var(--ease-out-quint), box-shadow 0.3s var(--ease-out-quint), background-color 0.3s, opacity 0.3s;
        }
        .btn:hover:not(:disabled) { transform: translateY(-3px) scale(1.02); }
        .btn:active:not(:disabled) { transform: translateY(-1px) scale(0.99); }
        .btn:disabled { cursor: not-allowed; opacity: 0.6; }
        .btn-scan { background-color: var(--accent-primary); color: var(--bg-color); box-shadow: 0 0 25px var(--glow-primary); }
        .btn-scan:hover:not(:disabled) { background-color: #67e8f9; box-shadow: 0 0 35px var(--glow-primary); }
        .btn-ai { background-color: var(--accent-secondary); color: var(--bg-color); box-shadow: 0 0 20px var(--glow-secondary); }
        .btn-ai:hover:not(:disabled) { background-color: #fbbf24; box-shadow: 0 0 30px var(--glow-secondary); }

        .threat-pill { transition: all 0.5s var(--ease-in-out-cubic); color: #020617; }
        .threat-low { background-color: #4ade80; }
        .threat-medium { background-color: #facc15; }
        .threat-high { background-color: #fb923c; }
        .threat-critical { background-color: var(--danger); box-shadow: 0 0 15px var(--glow-danger); }

        @keyframes slide-in-fade {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .log-entry-new { animation: slide-in-fade 0.6s var(--ease-out-quint) forwards; }

        #toast-container { position: fixed; top: calc(var(--safe-area-top) + 1rem); left: 50%; transform: translateX(-50%); z-index: 100; pointer-events: none; }
        .toast {
            background: var(--panel-bg); border: 1px solid var(--panel-border); color: var(--accent-secondary);
            padding: 0.75rem 1.5rem; border-radius: 9999px; font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 8px var(--glow-secondary); box-shadow: 0 0 20px var(--glow-secondary);
            opacity: 0; transform: translateY(-20px) scale(0.9);
            transition: all 0.4s var(--ease-out-quint);
        }
        .toast.show { opacity: 1; transform: translateY(0) scale(1); }

        #ai-modal { transition: opacity 0.4s var(--ease-in-out-cubic); }
        #ai-modal > div { transition: transform 0.4s var(--ease-out-quint), opacity 0.4s var(--ease-out-quint); }
        #ai-modal.hidden > div { transform: scale(0.95); opacity: 0; }
        .ai-modal-loader { width: 50px; height: 50px; border: 4px solid var(--panel-border); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .stagger-in { opacity: 0; transform: translateY(10px); }
        .is-visible { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body>
    
    <main id="scroll-container">
        <div class="content-wrapper">
            <div class="max-w-md mx-auto flex flex-col space-y-8">

                <header class="flex justify-between items-center px-2 z-10 stagger-in" style="transition: all 0.5s var(--ease-out-quint) 0.1s;">
                    <div id="threat-level-pill" class="threat-pill threat-low text-black font-bold text-sm py-1.5 px-4 rounded-full font-orbitron">HROZBA: NÍZKÁ</div>
                </header>

                <div id="radar-display" class="relative w-full aspect-square flex items-center justify-center my-4 stagger-in" style="transition: all 0.5s var(--ease-out-quint) 0.2s;">
                    <div class="radar-line"></div>
                    <div id="blip-container" class="absolute w-full h-full"></div>
                    <div class="font-orbitron text-center z-10 p-4">
                        <div id="scanner-status" class="text-3xl md:text-4xl">NAČÍTÁNÍ...</div>
                        <div id="scanner-subtext" class="text-sm">navazuji spojení</div>
                    </div>
                </div>

                <div class="stagger-in" style="transition: all 0.5s var(--ease-out-quint) 0.3s;">
                    <button id="scan-button" class="btn btn-scan w-full p-4 rounded-full text-xl font-orbitron font-bold tracking-wider">INICIALIZOVAT SKEN</button>
                </div>

                <div class="glass-panel p-6 stagger-in" style="transition: all 0.5s var(--ease-out-quint) 0.4s;">
                    <div class="flex justify-between items-center mb-4">
                         <h3 class="font-orbitron text-lg">ANALÝZA CÍLE</h3>
                         <button id="profile-button" class="btn btn-profile px-4 py-2 rounded-full text-xs font-orbitron font-bold text-black">PROFIL</button>
                    </div>
                    <div class="flex items-center space-x-4 mb-4">
                        <div id="avatar-wrapper" class="w-20 h-20 rounded-full border-2 border-cyan-400 shadow-lg flex-shrink-0" style="box-shadow: 0 0 20px var(--glow-primary); transition: opacity 0.4s var(--ease-in-out-cubic);">
                            <svg id="avatar-svg" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="50" cy="50" r="48" stroke="var(--accent-primary)" stroke-width="2"/>
                                <text id="avatar-text" x="50" y="55" font-family="Orbitron, sans-serif" font-size="20" fill="var(--accent-primary)" text-anchor="middle">ČEKÁM</text>
                            </svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div id="target-name" class="font-bold text-xl truncate" style="transition: opacity 0.4s var(--ease-in-out-cubic);">Načítání subjektu...</div>
                            <div id="target-status" class="text-sm text-slate-400">Stav: Neznámý</div>
                            <div id="target-threat-pill" class="mt-2 threat-pill threat-low text-black text-xs font-bold py-1 px-3 rounded-full inline-block">STUPEŇ OHROŽENÍ: NÍZKÝ</div>
                        </div>
                    </div>
                    <button id="ai-analysis-button" class="btn btn-ai w-full p-3 mt-2 rounded-full text-md font-orbitron font-bold tracking-wider hidden">✨ ZÍSKAT ANALÝZU</button>
                </div>

                <div class="glass-panel p-6 stagger-in" style="transition: all 0.5s var(--ease-out-quint) 0.5s;">
                    <h3 class="font-orbitron text-lg mb-4">LOG AKTIVIT</h3>
                    <ul id="activity-log" class="space-y-3 text-sm h-48 overflow-y-auto pr-2"></ul>
                </div>

            </div>
        </div>
    </main>

    <div id="toast-container"><div id="toast-message" class="toast"></div></div>

    <div id="ai-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="glass-panel w-full max-w-lg p-6 relative">
            <button id="modal-close-button" class="absolute top-4 right-4 text-slate-400 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
            </button>
            <h3 id="modal-title" class="font-orbitron text-xl mb-4"></h3>
            <div id="modal-content" class="text-slate-300 leading-relaxed max-h-[60vh] overflow-y-auto"></div>
            <div id="modal-loader" class="w-full flex justify-center items-center py-8 hidden"><div class="ai-modal-loader"></div></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const subjectsData = [
                { id: 'slehac', name: 'Šlehař Delta-Piko', avatar: 'ŠLEHAŘ', radarStatus: 'HOTOVEJ NA ŠLEH', radarSubtext: 'čekám na lajnu', profile: 'Původ: Uliční varna v Žižkově. Schopnosti: Pozná feťáka na 200 metrů. Slabiny: Bojí se holubů.', logPhrases: ['Vařím dávku, drž se', 'Šlehám vrstvičku I', 'Dealer hlásí, že zboží jede', 'Piko čistota 78 %, dobrý', 'Připravuju stříkačku', 'Váha ukazuje přesně, dneska to bude jízda.', 'Filtruju přes cigaretu, klasika.', 'Kyselina se odpařuje, cejtíš to?', 'Bacha, ať to nezcukernatí.', 'Zrcátko je čistý, lajna připravena.', 'Tep stoupá, zorničky jak talíře.', 'Právě jsem prodal starý rádio za gram.'] },
                { id: 'hulic', name: 'Hulič Zubatá Žárovka', avatar: 'HULIČ', radarStatus: 'ZAPALUJU SKLO', radarSubtext: 'už to bublá', profile: 'Původ: Skleník za panelákem. Schopnosti: Umí ubalit brko i poslepu. Slabiny: Neustále se směje vlastním vtipům.', logPhrases: ['Přepaluju sklo', 'Už to bublá, kámo', 'Mám totální červený oči', 'Kde je zapalovač?', 'Tohle je silnej model', 'Tenhle model lepí prsty, to je dobře.', 'Sháním papírky, došly mi.', 'Žárovka připravena k vaporizaci.', 'Mám vlčí hlad, objednávám pizzu.', 'Kde mám drtičku? Zase jsem ji ztratil.', 'Tohle je sativka, nebo indika? Už nevím.', 'Pouštím si chill-out mix, ať to má atmosféru.'] },
                { id: 'cichac', name: 'Čichač Trubek Omega', avatar: 'ČICHAČ', radarStatus: 'LETÍM DO NEBE', radarSubtext: 'čichám toluen', profile: 'Původ: Kanály pod hlavním nádražím. Schopnosti: Pozná značku ředidla po čichu. Slabiny: Často mluví s odpadkovými koši.', logPhrases: ['Čichám toluen z hadru', 'Tohle lepidlo je top', 'Mozek mi odchází na výlet', 'Kde je ta igelitka?', 'Všechno se točí', 'Dneska testuju novej druh ředidla.', 'Vzpomínky se rozmazávaj, barvy jsou hezčí.', 'Ten igeliťák už má díru, potřebuju novej.', 'Slyším ozvěny z kanálu, asi na mě mluví.', 'Tohle je lepší než voňavej stromeček.', 'Ztrácím pojem o čase... a o prostoru.', 'Kámo, půjč mi hadr, ten můj už je suchej.'] },
                { id: 'domingo', name: 'Domingo ze Smíchova', avatar: 'DEALER', radarStatus: 'ČISTEJ VZDUCH', radarSubtext: 'čekám na signál', profile: 'Původ: Lavička na Andělu. Schopnosti: Dokáže prodat cokoliv komukoliv. Kvalita zboží je... proměnlivá.', logPhrases: ['Mám čerstvej matroš, chceš?', 'Dneska akce, dva za cenu jednoho.', 'Bacha, za rohem stojej fízlové.', 'Platba jen v hotovosti, kámo.', 'Tohle je čistý, přísahám.', 'Znáš Pepu? Dluží mi prachy.', 'Potřebuju si rychle vydělat na nájem.', 'Nekoukej tak nápadně, nejsme tu sami.', 'Rychle, rychle, nemám čas.'] },
                { id: 'pedro', name: 'Pedro Perníček', avatar: 'DOVOZ', radarStatus: 'JSEM NA CESTĚ', radarSubtext: 'připrav si prachy', profile: 'Původ: Neznámý, vždy na cestě. Schopnosti: Expresní doručení až do domu 24/7. Slabiny: Občas si splete adresu.', logPhrases: ['Jsem na cestě, čekej.', 'Už jsem za rohem, připrav prachy.', 'Máš přesně? Nemám na vrácení.', 'Dneska mám zpoždění, kolony.', 'Nová várka, silnější než minule.', 'Nezvedáš telefon, co se děje?', 'Stojím před barákem, kde jsi?', 'Dneska jen perník, nic jinýho nemám.', 'Bonusovej gram za věrnost.'] },
                { id: 'chemik', name: 'Chemik z VŠCHT', avatar: 'CHEMIK', radarStatus: 'SYNTÉZA BĚŽÍ', radarSubtext: 'reakce stabilní', profile: 'Původ: Laboratoř v Dejvicích. Schopnosti: Syntetizuje s přesností na mikrogram. Slabiny: Potřebuje absolutní ticho a kávu.', toastPhrases: [], logPhrases: [] },
                { id: 'dispecer', name: 'Dispečer Sítě', avatar: 'DISPEČER', radarStatus: 'SÍŤ STABILNÍ', radarSubtext: 'všechny jednotky v pozici', profile: 'Původ: Anonymní serverovna. Schopnosti: Koordinuje logistiku celé sítě bez jediné chyby. Slabiny: Nikdy neopouští své křeslo.', toastPhrases: [], logPhrases: [] }
            ];
            const extraPhrases = {
                slehac: { toastPhrases: ['Čistota nad 80 %, leť.', 'Filtr čistý. Nezakecej.', 'Míchám to jak boží prst.', 'Teplota drží, nepřepal.', 'Vzorek stabilní. Plynule.', 'Syntéza v plným proudu.', 'Bez bublin, profi kvalita.', 'Mix jak od Michelina.', 'Krystal jak diamant.', 'Tlak drží – neměň nic.'], logPhrases: ['Zkumavka zpívá – čistý tón.', 'Mikro bubliny OK.', 'Měřák bliká zeleně.', 'Destilku dolít, ať to neškrábe.', 'Míchadlo v rytmu, drž tempo.', 'Povrch zrcadlo, bez puchýřů.', 'PH cajk, můžeme přitopit.', 'Vůně plastu mizí – dobrý signál.', 'Nálev bez kalu – paráda.', 'Laboratoř běží jak hodinky.', 'Tepelná křivka ideální.', 'Nic se nepřipaluje – top stav.'] },
                hulic: { toastPhrases: ['Táhne to. Drž linku.', 'Popel si sedá, klid.', 'Sklo čistý – respekt.', 'Seshni to na špičku.', 'Vlhkej kašel? Voda, kámo.', 'Plamen hřeje akorát.', 'Táhni pomalu, ať to drží.', 'Chuť jak první láska.', 'Žár rovnoměrnej.', 'Popelník v limitu.'], logPhrases: ['Zapal z boku, ať to nefouká.', 'Filtr se nechytá – luxus.', 'Kruh jak vinyl, stará škola.', 'Sídlo prachu: podložka.', 'Nehroť tah, nech to dýchat.', 'Aroma citrus-beton. Mmm.', 'Plamen malý, úsporný mód.', 'Kouř čistej jak horskej vzduch.', 'Žár bez praskání.', 'Sklo se leskne jak nový.', 'Pocit lehkosti – ideál.', 'Šluk jak z učebnice.'] },
                cichac: { toastPhrases: ['Hadr ready. Film běží.', 'Vdechni – nepřeháněj.', 'Profil drží, barvičky.', 'Víčko těsní, klídek.', 'Kanystr mlčí. Zatím.', 'Vůně se láme do sladka.', 'Vzduch má jiskru.', 'Film bez bublin.', 'Parfém továrny – deluxe.', 'Tlak voní stabilně.'], logPhrases: ['Vzduch se kroutí jak had.', 'Ticho v uších – jízda.', 'Stromek v autě? Ubohost.', 'Závan fabriky – nostalgie.', 'Čas gumovej. Přistávej pomalu.', 'Molekuly tančí ve spirále.', 'Nos brní, to je ono.', 'Filtr drží vůni pevně.', 'Hlavní aroma stabilní.', 'Lehká pachuť chemie – cajk.', 'Bublina času, nic se nehýbe.', 'Vzorek v limitu, můžeš jet.'] },
                domingo: { toastPhrases: ['Předávka v tichu.', 'Kamera za rohem – bacha.', 'Balíček nenápadnej.', 'Okno otevřený minutu.', 'Čas jsou prachy.', 'Stín mě kryje.', 'Zóna čistá.', 'Pohyb minimální.', 'Kontakt potvrzen.', 'Stopy vymazány.'], logPhrases: ['Koridor čistý, jdeme.', 'Plášť šustí – signál.', 'Stopy smaž, když odcházíš.', 'Telefon do kapsy, teď.', 'Zpětná kontrola: nikdo za náma.', 'Vchod chráněn, klid.', 'Nabitý plán, jedeme dál.', 'Bez zbytečných slov.', 'Otočka za roh a pryč.', 'Klidná zóna, žádný svědci.', 'Doručeno bez komplikací.', 'Obálka v bezpečí.'] },
                pedro: { toastPhrases: ['Brzdím. Brána?', 'Objížďka hotová.', 'Zvoním a mizím.', 'Expres režim.', 'Balík vakuuju.', 'Před domem za 2 minuty.', 'Parkuju vedle hydrantu.', 'Náklad drží pevně.', 'Bez zastávky – turbo.', 'Zatáčka a jsem tam.'], logPhrases: ['Byt vlevo, třetí zvonek.', 'Kolona na Barrandově – zpožďuju.', 'Parkuju u hydrantu, fofr.', 'V kufru to drží – žádný šust.', 'GPS hopsá, jsem blízko.', 'Světla zhasnutá, klidná příjezdovka.', 'Dodávka maskovaná v koloně.', 'Čas příjezdu přesnej na vteřinu.', 'Výjezd bez pozornosti okolí.', 'Doručeno a odjeto.', 'Zpoždění minimalizováno.', 'Trasa vyčištěná.'] },
                chemik: { toastPhrases: ['Reakce stabilní.', 'Vzorek pod kontrolou.', 'Teplota drží ±0,1°C.', 'PH přesně v normě.', 'Analýza běží.', 'Bezpečný roztok připraven.', 'Testovací série dokončena.', 'Přesně odměřeno.', 'Vzorek čistý jako slovo Boží.', 'Laboratoř v zelených číslech.'], logPhrases: ['Titrační křivka perfektní.', 'Měření přesné na mikron.', 'Žádná sedimentace.', 'Odpar 0,02 % – ideál.', 'Spektrum bez šumu.', 'Záznam uložen do protokolu.', 'Reaktor stabilní.', 'Výsledek potvrzen duplikátem.', 'Kalibrace 100 %. Hotovo.', 'Čas do další reakce: 3 min.', 'Žádné odchylky nenalezeny.', 'Parametry v normě.'] },
                dispecer: { toastPhrases: ['Trasa potvrzená.', 'Cíl v dosahu.', 'Další zastávka připravena.', 'Okno pro přesun otevřené.', 'Bezpečný koridor aktivní.', 'Příjezd podle plánu.', 'Všechny jednotky v pozici.', 'Synchronizace hotová.', 'Přesměrování bez zdržení.', 'Časová rezerva +2 min.'], logPhrases: ['Satelitní snímek ověřen.', 'Žádné překážky na trase.', 'Překresluju mapu pohybu.', 'Nový bod zájmu přidán.', 'Cílová zóna čistá.', 'Předávám souřadnice.', 'Radiový kontakt navázán.', 'Plán B připraven.', 'Synchronizace týmů dokončena.', 'Signál 100 %, spojení stabilní.', 'Časová osa aktualizována.', 'Bezpečný průchod potvrzen.'] }
            };
            
            const elements = {
                blipContainer: document.getElementById('blip-container'),
                threatPill: document.getElementById('threat-level-pill'),
                scanButton: document.getElementById('scan-button'),
                scannerStatus: document.getElementById('scanner-status'),
                scannerSubtext: document.getElementById('scanner-subtext'),
                activityLog: document.getElementById('activity-log'),
                aiAnalysisButton: document.getElementById('ai-analysis-button'),
                profileButton: document.getElementById('profile-button'),
                aiModal: document.getElementById('ai-modal'),
                modalTitle: document.getElementById('modal-title'),
                modalContent: document.getElementById('modal-content'),
                modalLoader: document.getElementById('modal-loader'),
                modalCloseButton: document.getElementById('modal-close-button'),
                targetName: document.getElementById('target-name'),
                avatarWrapper: document.getElementById('avatar-wrapper'),
                avatarText: document.getElementById('avatar-text'),
                targetStatus: document.getElementById('target-status'),
                targetThreatPill: document.getElementById('target-threat-pill'),
                toastMessage: document.getElementById('toast-message'),
                staggerElements: document.querySelectorAll('.stagger-in'),
            };

            // --- NOVINKA: Cache pro AI odpovědi ---
            const apiCache = {};
            let currentSubject = null;
            let logInterval, toastInterval, subjectSwitchInterval, typingInterval;
            
            const threatLevels = [
                { name: 'NÍZKÁ', class: 'threat-low', level: 0 }, { name: 'STŘEDNÍ', class: 'threat-medium', level: 1 },
                { name: 'VYSOKÁ', class: 'threat-high', level: 2 }, { name: 'KRITICKÁ', class: 'threat-critical', level: 3 }
            ];

            function getRandomItem(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

            function initializeSubjects() {
                return subjectsData.map(subject => {
                    const extras = extraPhrases[subject.id] || { toastPhrases: [], logPhrases: [] };
                    return { ...subject, toastPhrases: extras.toastPhrases, logPhrases: [...subject.logPhrases, ...extras.logPhrases] };
                });
            }
            const subjects = initializeSubjects();

            function showToast(message) {
                const toast = elements.toastMessage;
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => { toast.classList.remove('show'); }, 3000);
            }

            function addLogEntry(message, level = 'info') {
                const li = document.createElement('li');
                li.className = 'flex items-center space-x-3 border-t border-slate-700/50 pt-3 log-entry-new';
                const dotColors = { info: 'bg-green-400', warn: 'bg-yellow-400', error: 'bg-orange-400', critical: 'bg-red-400', ai: 'bg-purple-400', profile: 'bg-blue-400' };
                const time = new Date().toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                li.innerHTML = `<span class="w-2 h-2 rounded-full ${dotColors[level]}" style="box-shadow: 0 0 5px ${dotColors[level]}"></span><span class="text-slate-400">${time}</span><span class="flex-1">${message}</span>`;
                elements.activityLog.prepend(li);
                if (elements.activityLog.children.length > 15) { elements.activityLog.lastElementChild.remove(); }
            }
            
            function createBlips() {
                elements.blipContainer.innerHTML = '';
                for (let i = 0; i < 7; i++) {
                    const blip = document.createElement('div');
                    blip.className = 'blip';
                    const size = Math.random() * 8 + 6;
                    blip.style.width = `${size}px`;
                    blip.style.height = `${size}px`;
                    const angle = Math.random() * 2 * Math.PI;
                    const radius = Math.random() * 35 + 10;
                    blip.style.left = `${50 + radius * Math.cos(angle)}%`;
                    blip.style.top = `${50 + radius * Math.sin(angle)}%`;
                    blip.style.animationDelay = `${Math.random() * 3.5}s`;
                    elements.blipContainer.appendChild(blip);
                }
            }
            
            function typeText(element, text, callback) {
                clearInterval(typingInterval);
                let i = 0;
                element.textContent = '';
                typingInterval = setInterval(() => {
                    if (i < text.length) {
                        element.textContent += text.charAt(i);
                        i++;
                    } else {
                        clearInterval(typingInterval);
                        if (callback) callback();
                    }
                }, 50);
            }

            function switchSubject() {
                currentSubject = getRandomItem(subjects);
                
                typeText(elements.scannerStatus, currentSubject.radarStatus, () => {
                   typeText(elements.scannerSubtext, currentSubject.radarSubtext);
                });
                
                elements.targetName.style.opacity = '0';
                elements.avatarWrapper.style.opacity = '0';

                setTimeout(() => {
                    elements.targetName.textContent = currentSubject.name;
                    elements.avatarText.textContent = currentSubject.avatar;
                    elements.targetName.style.opacity = '1';
                    elements.avatarWrapper.style.opacity = '1';
                }, 300);

                const randomThreat = getRandomItem(threatLevels);
                elements.threatPill.textContent = `HROZBA: ${randomThreat.name}`;
                elements.threatPill.className = `threat-pill text-black font-bold text-sm py-1.5 px-4 rounded-full font-orbitron ${randomThreat.class}`;
                elements.targetThreatPill.textContent = `STUPEŇ OHROŽENÍ: ${randomThreat.name}`;
                elements.targetThreatPill.className = `mt-2 threat-pill text-black text-xs font-bold py-1 px-3 rounded-full inline-block ${randomThreat.class}`;
                elements.aiAnalysisButton.classList.toggle('hidden', randomThreat.level < 2);

                elements.activityLog.innerHTML = '';
                for(let i = 0; i < 4; i++) {
                    if (currentSubject.logPhrases.length > 0) {
                        addLogEntry(getRandomItem(currentSubject.logPhrases), 'info');
                    }
                }

                clearInterval(logInterval);
                logInterval = setInterval(() => {
                    if (currentSubject.logPhrases.length > 0) {
                        addLogEntry(getRandomItem(currentSubject.logPhrases), 'info');
                    }
                }, Math.random() * 4000 + 8000);

                clearInterval(toastInterval);
                toastInterval = setInterval(() => {
                    if (currentSubject.toastPhrases.length > 0) {
                        showToast(getRandomItem(currentSubject.toastPhrases));
                    }
                }, Math.random() * 5000 + 10000);
            }

            function showModal(title) {
                elements.modalTitle.textContent = title;
                elements.modalContent.innerHTML = '';
                elements.modalLoader.classList.remove('hidden');
                elements.aiModal.classList.remove('hidden');
                setTimeout(() => elements.aiModal.style.opacity = '1', 10);
            }

            function hideModal() {
                elements.aiModal.style.opacity = '0';
                setTimeout(() => elements.aiModal.classList.add('hidden'), 400);
            }

            async function callGeminiAPI(prompt, cacheKey) {
                if (apiCache[cacheKey]) {
                    return apiCache[cacheKey];
                }
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error(`Chyba API: ${response.statusText}`);
                const result = await response.json();
                const text = result.candidates[0].content.parts[0].text;
                apiCache[cacheKey] = text; // Uložení do cache
                return text;
            }

            async function getThreatAnalysis() {
                if (!currentSubject) return;
                elements.aiAnalysisButton.disabled = true;
                addLogEntry('Vyžádána taktická analýza...', 'ai');
                showModal('AI TAKTICKÁ ANALÝZA');
                const cacheKey = `${currentSubject.id}_analysis`;
                const prompt = `Jsi expert na bezpečnostní analýzu. Cíl je '${currentSubject.name}'. Jeho profil: '${currentSubject.profile}'. Aktuální úroveň hrozby je VYSOKÁ. Stručně (max 3 věty) vygeneruj taktickou analýzu a doporuč okamžité kroky. Odpověz česky.`;
                try {
                    elements.modalContent.innerText = await callGeminiAPI(prompt, cacheKey);
                } catch (error) {
                    elements.modalContent.innerText = `Chyba: Nepodařilo se načíst analýzu. ${error.message}`;
                } finally {
                    elements.modalLoader.classList.add('hidden');
                    elements.aiAnalysisButton.disabled = false;
                }
            }
            
            async function getSubjectProfile() {
                if (!currentSubject) return;
                elements.profileButton.disabled = true;
                addLogEntry('Vyžádán profil subjektu...', 'profile');
                showModal(`PROFIL: ${currentSubject.name}`);
                const cacheKey = `${currentSubject.id}_profile`;
                const prompt = `Jsi AI analytik. Na základě tohoto stručného popisu: "${currentSubject.profile}", vytvoř podrobnější, ale stále stručný a poutavý fiktivní profil. Rozepiš jeho původ, schopnosti a slabiny do několika vět. Udržuj tón tajné zprávy. Odpověz česky v odstavcích.`;
                try {
                    const profileText = await callGeminiAPI(prompt, cacheKey);
                    elements.modalContent.innerHTML = profileText.replace(/\n/g, '<br><br>');
                } catch (error) {
                    elements.modalContent.innerText = `Chyba: Nepodařilo se vygenerovat profil. ${error.message}`;
                } finally {
                    elements.modalLoader.classList.add('hidden');
                    elements.profileButton.disabled = false;
                }
            }

            elements.aiAnalysisButton.addEventListener('click', getThreatAnalysis);
            elements.profileButton.addEventListener('click', getSubjectProfile);
            elements.modalCloseButton.addEventListener('click', hideModal);
            elements.aiModal.addEventListener('click', (e) => { if(e.target === elements.aiModal) hideModal(); });

            function init() {
                addLogEntry('Systém online. Načítám databázi subjektů...', 'info');
                createBlips();
                setInterval(createBlips, 5000);
                switchSubject();
                subjectSwitchInterval = setInterval(switchSubject, 20000);
                
                elements.staggerElements.forEach((el, index) => {
                    setTimeout(() => {
                        el.classList.add('is-visible');
                    }, 100 * index);
                });
            }
            init();
        });
    </script>
</body>
</html>