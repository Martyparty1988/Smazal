<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jsem Smažka - Pokročilá Kyber-analýza</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Face-api.js for face detection -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-gradient: linear-gradient(-45deg, #0f0c29, #1c1a3a, #0d1a3a, #0f0c29);
            --text-color: #ffffff;
            --text-muted-color: #9ca3af;
            --glass-bg: rgba(15, 23, 42, 0.6);
            --glass-border: rgba(45, 212, 191, 0.2);
            --primary-glow: #2dd4bf;
            --secondary-glow: #38bdf8;
        }

        [data-theme="light"] {
            --bg-gradient: linear-gradient(-45deg, #e0e7ff, #c7d2fe, #e0f2fe, #e0e7ff);
            --text-color: #111827;
            --text-muted-color: #4b5563;
            --glass-bg: rgba(255, 255, 255, 0.6);
            --glass-border: rgba(56, 189, 248, 0.4);
            --primary-glow: #0d9488;
            --secondary-glow: #0284c7;
        }

        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
            background: var(--bg-gradient);
            color: var(--text-color);
            background-size: 400% 400%;
            animation: gradient-animation 15s ease infinite;
            transition: background 0.5s, color 0.5s;
        }
        h1 { font-family: 'Chakra Petch', sans-serif; }
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            transition: background 0.5s, border 0.5s;
        }
        .neon-glow {
            text-shadow: 0 0 4px var(--text-color), 0 0 8px var(--primary-glow), 0 0 12px var(--primary-glow), 0 0 16px var(--primary-glow);
        }
        .text-gradient {
            background: linear-gradient(90deg, var(--primary-glow), var(--secondary-glow));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; text-fill-color: transparent;
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid var(--primary-glow);
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        #scan-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; will-change: transform, opacity;
        }
        /* Theme toggle styles */
        .theme-switch-wrapper { display: flex; align-items: center; }
        .theme-switch { display: inline-block; height: 26px; position: relative; width: 50px; }
        .theme-switch input { display:none; }
        .slider { background-color: #4b5563; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 26px; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 18px; left: 4px; position: absolute; transition: .4s; width: 18px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-glow); }
        input:checked + .slider:before { transform: translateX(24px); }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md mx-auto glass-card rounded-2xl shadow-2xl p-6 text-center">
        
        <div class="absolute top-4 right-4 theme-switch-wrapper">
            <label class="theme-switch" for="theme-toggle" aria-label="Přepnout tmavý/světlý režim">
                <input type="checkbox" id="theme-toggle">
                <span class="slider"></span>
            </label>
        </div>

        <h1 class="text-5xl font-bold text-gradient mb-2">Jsem Smažka</h1>
        <p class="mb-6 text-muted-color">Kybernetická analýza existenciální krize.</p>

        <div id="camera-container" class="relative w-full aspect-video bg-black/30 rounded-xl mb-6 overflow-hidden border border-white/20">
            <video id="video" class="w-full h-full object-cover" autoplay playsinline muted></video>
            <canvas id="scan-canvas"></canvas>
            <div id="permission-prompt" class="absolute inset-0 flex flex-col items-center justify-center p-4 bg-black/50">
                <div id="model-loader" class="hidden mb-4">
                    <div class="loader mx-auto"></div>
                    <p class="mt-2 text-sm">Načítám AI modely...</p>
                </div>
                <p id="prompt-text" class="mb-4 font-semibold">Povol kameru a odhal pravdu.</p>
                <button id="start-camera" class="bg-teal-400 hover:bg-teal-500 text-gray-900 font-bold py-2 px-5 rounded-lg transition-transform transform hover:scale-105">
                    Spustit kameru
                </button>
            </div>
            <button id="switch-camera" aria-label="Přepnout kameru" class="hidden absolute bottom-2 right-2 bg-black/50 p-2 rounded-full hover:bg-black/75">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2.5a2.5 2.5 0 0 0-5 0V5a2.5 2.5 0 0 0 5 0V2.5z"/><path d="M12 5v1"/><path d="M18 7.5a6 6 0 0 0-12 0v3a6 6 0 0 0 6 6h0a6 6 0 0 0 6-6v-3z"/><path d="M12 16.5V20l-2 1.5M12 20l2 1.5"/></svg>
            </button>
        </div>

        <button id="analyze-button" class="w-full bg-gradient-to-r from-teal-400 to-blue-500 text-gray-900 font-bold text-lg py-3 px-6 rounded-xl hover:opacity-90 transition-all duration-300 transform hover:scale-105 disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed disabled:transform-none disabled:opacity-50" disabled>
            Spustit kyber-analýzu
        </button>

        <div id="result-section" aria-live="polite" class="mt-8 hidden">
            <div id="loader" class="loader mx-auto mb-4"></div>
            <p id="loading-text" class="text-lg animate-pulse text-muted-color">Kalibrace senzorů... Skenuji biometrii...</p>
            
            <div id="result-content" class="hidden">
                <h2 class="text-2xl font-semibold text-gradient mb-2">Verdikt:</h2>
                <p id="result-percentage" class="text-6xl font-bold my-3 neon-glow"></p>
                <p id="result-message" class="text-lg px-4 text-muted-color"></p>
                <button id="share-button" class="mt-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Sdílet výsledek</button>
            </div>
        </div>
        
        <div id="share-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center p-4">
            <div class="bg-gray-800 p-6 rounded-lg text-center max-w-sm w-full">
                <h3 class="text-xl font-bold mb-4">Váš výsledek je připraven!</h3>
                <canvas id="share-canvas" class="w-full rounded-lg"></canvas>
                <a id="download-link" class="mt-4 inline-block bg-green-500 text-white font-bold py-2 px-6 rounded-lg" download="jsem_smazka_vysledek.png">Stáhnout</a>
                <button id="close-modal" class="mt-4 text-gray-400">Zavřít</button>
            </div>
        </div>

    </div>
    
    <footer class="mt-8 text-center text-sm text-muted-color">
        <p>&copy; 2024 Corporation 'Na plech'.</p>
        <p class="mt-1">Tohle není lékařská rada. Pokud vidíš draky, je to tvůj problém.</p>
    </footer>

    <script>
        // --- DOM Elements ---
        const video = document.getElementById('video');
        const analyzeButton = document.getElementById('analyze-button');
        const permissionPrompt = document.getElementById('permission-prompt');
        const resultSection = document.getElementById('result-section');
        const loader = document.getElementById('loader');
        const loadingText = document.getElementById('loading-text');
        const resultContent = document.getElementById('result-content');
        const resultPercentage = document.getElementById('result-percentage');
        const resultMessage = document.getElementById('result-message');
        const switchCameraButton = document.getElementById('switch-camera');
        const startButton = document.getElementById('start-camera');
        const modelLoader = document.getElementById('model-loader');
        const promptText = document.getElementById('prompt-text');
        const themeToggle = document.getElementById('theme-toggle');
        const shareButton = document.getElementById('share-button');
        const shareModal = document.getElementById('share-modal');
        const shareCanvas = document.getElementById('share-canvas');
        const downloadLink = document.getElementById('download-link');
        const closeModal = document.getElementById('close-modal');
        
        const canvas = document.getElementById('scan-canvas');
        const ctx = canvas.getContext('2d');
        
        // --- State Variables ---
        let currentStream;
        let facingMode = 'user';
        let animationFrameId;
        let particles = [];
        let lastResult = {};
        let audioContext;

        // --- Hlášky ---
        const funnyMessages = {
            mild: [
                "Jsi v klidu, kámo. Můžeš si dát ještě jednoho.",
                "Oči jako angorák, ale mozek ještě funguje.",
                "Jsi tak akorát. Ideální stav pro sledování dokumentů o zvířatech.",
            ],
            medium: [
                "Vesmír ti leží u nohou. Nebo jsi jenom mimo?",
                "Tvoje třetí oko je plně otevřené.",
                "Vypadáš, že bys teď vyřešil záhady vesmíru.",
                "Sleduješ mouchu na zdi už 5 minut. A fandíš jí.",
                "Realita ti právě dala facku, ale tys to necítil.",
            ],
            extreme: [
                "Tvoje zorničky jsou tak velký, že by tě nepustili ani do Studia 54 v jeho nejlepších letech.",
                "Vypadáš, že jsi právě předjel kamion plnej jehel. V odstavným pruhu.",
                "Stav: 'Perníkový táta'. Jenom bez toho vaření.",
                "Analýza ukazuje stopy... všeho. Absolutně všeho.",
                "Volali ze Studia 54, že prej už máš doživotní zákaz.",
                "Jsi tak mimo, že by tě ani Google Maps nenašly.",
                "Gratuluji, překročil jsi horizont událostí. Zpáteční lístek neexistuje.",
                "Tvoje DNA volá o pomoc. Latinsky.",
                "I Schrödingerova kočka ví, že jsi úplně mimo.",
                "Stav: Komunikuješ s nábytkem pomocí telepatie."
            ]
        };

        // --- Audio ---
        function playSound(type) {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            if (type === 'start') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(300, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 1);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 1);
            } else if (type === 'end') {
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.2);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            }
        }

        // --- Theme ---
        function switchTheme(e) {
            if (e.target.checked) {
                document.body.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
            } else {
                document.body.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            }    
        }
        const currentTheme = localStorage.getItem('theme');
        if (currentTheme) {
            document.body.setAttribute('data-theme', currentTheme);
            if (currentTheme === 'light') themeToggle.checked = true;
        }

        // --- Camera & Face-API ---
        async function loadModels() {
            const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
            modelLoader.classList.remove('hidden');
            promptText.classList.add('hidden');
            startButton.classList.add('hidden');
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            modelLoader.classList.add('hidden');
            promptText.classList.remove('hidden');
            startButton.classList.remove('hidden');
        }

        function stopCameraStream() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
        }

        async function startCamera() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                promptText.textContent = "Tvůj prohlížeč nepodporuje přístup ke kameře.";
                return;
            }
            stopCameraStream();
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode } });
                currentStream = stream;
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                };
                permissionPrompt.classList.add('hidden');
                analyzeButton.disabled = false;
                switchCameraButton.classList.remove('hidden');
            } catch (err) {
                console.error("Chyba kamery: ", err);
                promptText.textContent = "Nepodařilo se získat přístup ke kameře.";
            }
        }

        async function switchCamera() {
            facingMode = facingMode === 'user' ? 'environment' : 'user';
            await startCamera();
        }

        // --- Animation ---
        function createParticles(count) {
            particles = [];
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 2 + 1,
                    opacity: Math.random() * 0.5 + 0.2,
                });
            }
        }

        async function drawScanAnimation(startTime) {
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();
            const face = detections[0]; // Use the first detected face

            const currentTime = Date.now();
            const elapsedTime = currentTime - startTime;
            const duration = 3000;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Particles
            particles.forEach(p => {
                ctx.fillStyle = `rgba(45, 212, 191, ${p.opacity})`;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
            });

            // Scan Line
            const scanY = (canvas.height / duration) * elapsedTime;
            ctx.strokeStyle = '#2dd4bf';
            ctx.lineWidth = 2;
            ctx.shadowColor = '#2dd4bf';
            ctx.shadowBlur = 20;
            ctx.beginPath();
            ctx.moveTo(0, scanY);
            ctx.lineTo(canvas.width, scanY);
            ctx.stroke();
            ctx.shadowBlur = 0;

            if (face) {
                const { x, y, width, height } = face.detection.box;
                ctx.strokeStyle = 'rgba(56, 189, 248, 0.9)';
                ctx.lineWidth = 3;
                ctx.strokeRect(x, y, width, height);
                // Draw face landmarks
                ctx.fillStyle = 'rgba(45, 212, 191, 0.8)';
                face.landmarks.positions.forEach(pos => {
                    ctx.beginPath();
                    ctx.arc(pos.x, pos.y, 2, 0, Math.PI * 2);
                    ctx.fill();
                });
            }

            if (elapsedTime < duration) {
                animationFrameId = requestAnimationFrame(() => drawScanAnimation(startTime));
            } else {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        // --- Main Logic ---
        function analyze() {
            playSound('start');
            resultContent.classList.add('hidden');
            resultContent.classList.remove('fade-in');
            resultSection.classList.remove('hidden');
            loader.classList.remove('hidden');
            loadingText.classList.remove('hidden');
            analyzeButton.disabled = true;
            analyzeButton.textContent = 'PROBÍHÁ ANALÝZA...';
            
            createParticles(100);
            const startTime = Date.now();
            animationFrameId = requestAnimationFrame(() => drawScanAnimation(startTime));

            setTimeout(() => {
                playSound('end');
                cancelAnimationFrame(animationFrameId);
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                const percentage = Math.floor(Math.random() * 91) + 10;
                let category;
                if (percentage < 40) category = 'mild';
                else if (percentage < 80) category = 'medium';
                else category = 'extreme';
                
                const messages = funnyMessages[category];
                const message = messages[Math.floor(Math.random() * messages.length)];
                
                lastResult = { percentage, message };
                resultPercentage.textContent = `${percentage}%`;
                resultMessage.textContent = message;
                
                loader.classList.add('hidden');
                loadingText.classList.add('hidden');
                resultContent.classList.remove('hidden');
                resultContent.classList.add('fade-in');
                
                analyzeButton.disabled = false;
                analyzeButton.textContent = 'Spustit kyber-analýzu';

            }, 3000);
        }
        
        // --- Sharing ---
        function generateShareImage() {
            const { percentage, message } = lastResult;
            const sCtx = shareCanvas.getContext('2d');
            const w = 500;
            const h = 500;
            shareCanvas.width = w;
            shareCanvas.height = h;

            // Gradient background
            const gradient = sCtx.createLinearGradient(0, 0, w, h);
            gradient.addColorStop(0, '#0f0c29');
            gradient.addColorStop(1, '#0d1a3a');
            sCtx.fillStyle = gradient;
            sCtx.fillRect(0, 0, w, h);

            // Title
            sCtx.font = 'bold 48px "Chakra Petch"';
            sCtx.fillStyle = '#2dd4bf';
            sCtx.textAlign = 'center';
            sCtx.fillText('Jsem Smažka', w / 2, 80);
            
            // Percentage
            sCtx.font = 'bold 120px "Inter"';
            sCtx.fillStyle = '#ffffff';
            sCtx.shadowColor = '#2dd4bf';
            sCtx.shadowBlur = 20;
            sCtx.fillText(`${percentage}%`, w / 2, 220);
            sCtx.shadowBlur = 0;

            // Message
            sCtx.font = '20px "Inter"';
            sCtx.fillStyle = '#9ca3af';
            sCtx.textAlign = 'center';
            wrapText(sCtx, message, w / 2, 320, w - 40, 28);

            // Footer
            sCtx.font = '14px "Inter"';
            sCtx.fillStyle = '#6b7280';
            sCtx.fillText('Vygenerováno na smazka.web.app', w / 2, h - 30);

            downloadLink.href = shareCanvas.toDataURL('image/png');
            shareModal.classList.remove('hidden');
        }

        function wrapText(context, text, x, y, maxWidth, lineHeight) {
            const words = text.split(' ');
            let line = '';
            for(let n = 0; n < words.length; n++) {
                const testLine = line + words[n] + ' ';
                const metrics = context.measureText(testLine);
                const testWidth = metrics.width;
                if (testWidth > maxWidth && n > 0) {
                    context.fillText(line, x, y);
                    line = words[n] + ' ';
                    y += lineHeight;
                } else {
                    line = testLine;
                }
            }
            context.fillText(line, x, y);
        }

        // --- Event Listeners ---
        startButton.addEventListener('click', startCamera);
        analyzeButton.addEventListener('click', analyze);
        switchCameraButton.addEventListener('click', switchCamera);
        themeToggle.addEventListener('change', switchTheme);
        shareButton.addEventListener('click', generateShareImage);
        closeModal.addEventListener('click', () => shareModal.classList.add('hidden'));
        window.addEventListener('beforeunload', stopCameraStream);

        // --- Initialization ---
        loadModels();

    </script>
</body>
</html>