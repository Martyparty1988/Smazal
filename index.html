<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Futuristické UI Skeneru v6.1 (Optimalizováno pro iOS)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-gradient-start: #0a192f; --bg-gradient-mid: #0d4e5a; --bg-gradient-end: #4a0e4e;
            --accent-blue: #00f6ff; --accent-purple: #a855f7; --accent-yellow: #facc15;
            --accent-orange: #fb923c; --accent-red: #f87171; --accent-green: #4ade80;
            --text-primary: #e2e8f0; --text-secondary: #94a3b8;
            --glass-bg: rgba(28, 37, 61, 0.6); --glass-border: rgba(100, 116, 139, 0.25);
            --glow-blue: rgba(0, 246, 255, 0.35); --glow-purple: rgba(168, 85, 247, 0.4);
            --glow-yellow: rgba(250, 204, 21, 0.4); --glow-red: rgba(248, 113, 113, 0.5);
            /* Důležité: Definice proměnných pro bezpečné zóny s výchozími hodnotami */
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-right: env(safe-area-inset-right, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-left: env(safe-area-inset-left, 0px);
        }

        /* --- NOVINKA: Optimalizace pro iOS Fullscreen & Scrolling --- */
        html, body {
            position: fixed; /* Uzamkne viewport, zabrání posouvání body */
            width: 100%;
            height: 100%;
            overflow: hidden; /* Skryje jakýkoliv přetékající obsah na úrovni body */
            overscroll-behavior: none; /* Zabrání "pull-to-refresh" a dalším přetahovacím gestům */
            font-family: 'Share Tech Mono', monospace;
            background: linear-gradient(160deg, var(--bg-gradient-start) 0%, var(--bg-gradient-mid) 50%, var(--bg-gradient-end) 100%);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        }

        /* Kontejner, který bude reálně scrollovatelný */
        main#scroll-container {
            width: 100%;
            height: 100vh; /* Fallback pro starší prohlížeče */
            height: 100dvh; /* Dynamická výška viewportu pro Safari, reaguje na zobrazení/skrytí lišt */
            overflow-y: auto; /* Povolí vertikální scrollbar pouze pro tento element */
            -webkit-overflow-scrolling: touch; /* Zapne plynulé, "nativní" scrollování na iOS */
            position: relative; /* Nutné pro správné fungování scrollování v tomto kontextu */
        }
        
        /* Obal obsahu, na který aplikujeme bezpečné zóny */
        .content-wrapper {
            /* Aplikuje padding podle bezpečných zón zařízení */
            padding-top: calc(var(--safe-area-top) + 1rem);
            padding-right: calc(var(--safe-area-right) + 1rem);
            /* Přidává extra mezeru dole, aby se obsah nedostal pod "home bar" na iPhonech */
            padding-bottom: calc(var(--safe-area-bottom) + 2rem); 
            padding-left: calc(var(--safe-area-left) + 1rem);
        }

        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 800"><rect fill="%230a192f" width="800" height="800"/><g fill-opacity="0.1"><circle fill="%230d4e5a" cx="400" cy="400" r="600"/><circle fill="%231d3b5f" cx="400" cy="400" r="500"/><circle fill="%230a192f" cx="400" cy="400" r="300"/><circle fill="%231d3b5f" cx="400" cy="400" r="200"/><circle fill="%234a0e4e" cx="400" cy="400" r="100"/></g></svg>');
            opacity: 0.05; pointer-events: none; z-index: -1;
        }
        h1, h2, h3, .font-orbitron { font-family: 'Orbitron', sans-serif; text-shadow: 0 0 8px var(--glow-blue); }
        .glass-panel {
            background: var(--glass-bg); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border); border-radius: 24px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        }
        .scanner-pulse {
            position: absolute; border-radius: 50%; border: 1px solid var(--accent-blue);
            animation: pulse 4s infinite cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 25px 5px var(--glow-blue), inset 0 0 20px 3px var(--glow-blue);
        }
        .scanner-pulse:nth-child(2) { animation-delay: 1.33s; }
        .scanner-pulse:nth-child(3) { animation-delay: 2.66s; }
        .animate-pulse-fast .scanner-pulse { animation-duration: 1.5s; }
        @keyframes pulse { 0% { transform: scale(0.1); opacity: 0; } 70% { opacity: 0.5; } 100% { transform: scale(1); opacity: 0; } }
        .blip {
            position: absolute; border-radius: 50%; background-color: var(--accent-blue);
            box-shadow: 0 0 12px 3px var(--glow-blue); animation: fade-in-out 3.5s infinite alternate ease-in-out; opacity: 0;
        }
        @keyframes fade-in-out { 0%, 100% { opacity: 0; transform: scale(0.4); } 50% { opacity: 0.8; transform: scale(1); } }
        .btn { transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        .btn:active:not(:disabled) { transform: scale(0.98); }
        .btn:disabled { cursor: not-allowed; filter: grayscale(80%); opacity: 0.7; }
        .btn-scan { background: linear-gradient(45deg, var(--accent-blue), var(--accent-purple)); box-shadow: 0 0 25px 5px var(--glow-blue); }
        .btn-scan:hover:not(:disabled) { box-shadow: 0 0 35px 8px var(--glow-purple); }
        .btn-scan:active:not(:disabled) { box-shadow: 0 0 20px 2px var(--glow-purple); }
        .btn-ai { background: linear-gradient(45deg, var(--accent-yellow), var(--accent-orange)); box-shadow: 0 0 20px 4px var(--glow-yellow); }
        .btn-ai:hover:not(:disabled) { box-shadow: 0 0 30px 7px var(--glow-yellow); }
        .btn-profile { background: linear-gradient(45deg, var(--accent-blue), #38bdf8); box-shadow: 0 0 20px 4px var(--glow-blue); }
        .btn-profile:hover:not(:disabled) { box-shadow: 0 0 30px 7px var(--glow-blue); }
        .threat-pill { transition: all 0.5s ease; }
        .threat-low { background-color: var(--accent-green); box-shadow: 0 0 12px var(--accent-green); }
        .threat-medium { background-color: var(--accent-yellow); box-shadow: 0 0 12px var(--accent-yellow); }
        .threat-high { background-color: var(--accent-orange); box-shadow: 0 0 12px var(--accent-orange); }
        .threat-critical { background-color: var(--accent-red); box-shadow: 0 0 15px var(--glow-red); }
        #ai-modal { transition: opacity 0.3s ease; }
        .ai-modal-loader {
            width: 50px; height: 50px; border: 4px solid var(--glass-border);
            border-top-color: var(--accent-blue); border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* NOVINKA: Media query pro menší obrazovky (např. iPhone SE) */
        @media (max-height: 700px) {
            .content-wrapper > .space-y-6 > :not([hidden]) ~ :not([hidden]) {
                --tw-space-y-reverse: 0;
                margin-top: calc(1rem * calc(1 - var(--tw-space-y-reverse)));
                margin-bottom: calc(1rem * var(--tw-space-y-reverse));
            }
            .font-orbitron.text-xl { font-size: 1.125rem; }
            .btn-scan { padding: 0.75rem; font-size: 1.125rem; }
        }

        @media (prefers-reduced-motion: reduce) {
          .scanner-pulse, .blip, .btn, .threat-pill { animation: none !important; transition-duration: 0.01ms !important; }
        }
    </style>
</head>
<body>

    <!-- NOVINKA: Hlavní scrollovací kontejner -->
    <main id="scroll-container">
        <!-- NOVINKA: Obal obsahu pro aplikaci bezpečných zón -->
        <div class="content-wrapper">
            <div class="max-w-md mx-auto flex flex-col space-y-6">

                <header class="flex justify-between items-center px-2 z-10">
                    <div id="threat-level-pill" class="threat-pill threat-low text-black font-bold text-sm py-1.5 px-4 rounded-full font-orbitron">HROZBA: NÍZKÁ</div>
                </header>

                <div class="relative w-full aspect-square flex items-center justify-center my-4">
                    <div id="scanner-container" class="absolute w-full h-full">
                        <div class="scanner-pulse w-full h-full"></div>
                        <div class="scanner-pulse w-full h-full"></div>
                        <div class="scanner-pulse w-full h-full"></div>
                    </div>
                    <div class="font-orbitron text-center z-10">
                        <div id="scanner-status" class="text-3xl font-bold text-cyan-300 transition-all" style="text-shadow: 0 0 15px var(--glow-blue);">PŘIPRAVEN</div>
                        <div id="scanner-subtext" class="text-sm text-slate-400 transition-all">Čekám na příkaz</div>
                    </div>
                </div>

                <button id="scan-button" class="btn btn-scan w-full p-4 rounded-full text-xl font-orbitron font-bold text-black tracking-wider">INICIALIZOVAT SKEN</button>

                <div class="glass-panel p-5">
                    <div class="flex justify-between items-center mb-4">
                         <h3 class="font-orbitron text-lg">ANALÝZA CÍLE</h3>
                         <button id="profile-button" class="btn btn-profile px-3 py-1 rounded-full text-xs font-orbitron font-bold text-black">PROFIL SUBJEKTU</button>
                    </div>
                    <div class="flex items-center space-x-4 mb-4">
                        <div class="w-20 h-20 rounded-full border-2 border-cyan-400 shadow-lg flex-shrink-0" style="box-shadow: 0 0 15px var(--glow-blue);">
                            <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="50" cy="50" r="48" stroke="var(--accent-blue)" stroke-width="2"/><path d="M50 30C58.2843 30 65 36.7157 65 45C65 53.2843 58.2843 60 50 60C41.7157 60 35 53.2843 35 45C35 36.7157 41.7157 30 50 30Z" stroke="var(--accent-blue)" stroke-width="2"/><path d="M25 85C25 73.9543 36.1929 65 50 65C63.8071 65 75 73.9543 75 85" stroke="var(--accent-blue)" stroke-width="2" stroke-linecap="round"/><text x="50" y="52" font-family="Orbitron, sans-serif" font-size="24" fill="var(--accent-blue)" text-anchor="middle" dominant-baseline="middle">K-7</text>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="font-bold text-xl">Subjekt KAPPA-7</div>
                            <div id="target-status" class="text-sm text-slate-400">Stav: Stabilní</div>
                            <div id="target-threat-pill" class="mt-2 threat-pill threat-low text-black text-xs font-bold py-1 px-3 rounded-full inline-block">STUPEŇ OHROŽENÍ: NÍZKÝ</div>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="grid grid-cols-2 gap-2 text-center text-xs">
                             <div class="glass-panel p-2 rounded-lg"><div id="stat-bpm" class="font-bold text-base text-yellow-400">82</div><div>BPM</div></div>
                             <div class="glass-panel p-2 rounded-lg"><div id="stat-risk" class="font-bold text-base text-yellow-400">18%</div><div>RIZIKO</div></div>
                        </div>
                        <button id="ai-analysis-button" class="btn btn-ai w-full p-3 mt-2 rounded-full text-md font-orbitron font-bold text-black tracking-wider hidden">✨ ZÍSKAT ANALÝZU</button>
                    </div>
                </div>

                <div class="glass-panel p-5">
                    <h3 class="font-orbitron text-lg mb-4">LOG AKTIVIT</h3>
                    <ul id="activity-log" class="space-y-3 text-sm h-40 overflow-y-auto pr-2"></ul>
                </div>

            </div>
        </div>
    </main>

    <!-- Modální okno zůstává mimo scrollovací kontejner, aby se zobrazilo přes celou obrazovku -->
    <div id="ai-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="glass-panel w-full max-w-lg p-6 relative">
            <button id="modal-close-button" class="absolute top-4 right-4 text-slate-400 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
            </button>
            <h3 id="modal-title" class="font-orbitron text-xl mb-4 text-cyan-300"></h3>
            <div id="modal-content" class="text-slate-300 leading-relaxed max-h-[60vh] overflow-y-auto"></div>
            <div id="modal-loader" class="w-full flex justify-center items-center py-8 hidden"><div class="ai-modal-loader"></div></div>
        </div>
    </div>

    <script>
        // JavaScript kód zůstává beze změny, protože se stará o logiku, nikoliv o rozložení.
        document.addEventListener('DOMContentLoaded', () => {
            const elements = {
                scannerContainer: document.getElementById('scanner-container'),
                threatPill: document.getElementById('threat-level-pill'),
                scanButton: document.getElementById('scan-button'),
                scannerStatus: document.getElementById('scanner-status'),
                scannerSubtext: document.getElementById('scanner-subtext'),
                activityLog: document.getElementById('activity-log'),
                statBpm: document.getElementById('stat-bpm'),
                statRisk: document.getElementById('stat-risk'),
                aiAnalysisButton: document.getElementById('ai-analysis-button'),
                profileButton: document.getElementById('profile-button'),
                aiModal: document.getElementById('ai-modal'),
                modalTitle: document.getElementById('modal-title'),
                modalContent: document.getElementById('modal-content'),
                modalLoader: document.getElementById('modal-loader'),
                modalCloseButton: document.getElementById('modal-close-button'),
                targetThreatPill: document.getElementById('target-threat-pill'),
            };

            let isScanning = false;
            let currentThreatIndex = 0;
            const threatLevels = [
                { name: 'NÍZKÁ', class: 'threat-low', level: 0 }, { name: 'STŘEDNÍ', class: 'threat-medium', level: 1 },
                { name: 'VYSOKÁ', class: 'threat-high', level: 2 }, { name: 'KRITICKÁ', class: 'threat-critical', level: 3 }
            ];

            const random = (min, max) => Math.random() * (max - min) + min;
            const randomInt = (min, max) => Math.floor(random(min, max + 1));

            function addLogEntry(message, level = 'info') {
                const li = document.createElement('li');
                li.className = 'flex items-center space-x-3 border-t border-slate-700/50 pt-3';
                const dotColors = { info: 'bg-green-400', warn: 'bg-yellow-400', error: 'bg-orange-400', critical: 'bg-red-400', ai: 'bg-purple-400', profile: 'bg-blue-400' };
                const dotShadows = { info: 'var(--accent-green)', warn: 'var(--accent-yellow)', error: 'var(--accent-orange)', critical: 'var(--accent-red)', ai: 'var(--glow-purple)', profile: 'var(--glow-blue)' };
                const time = new Date().toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                let entryHTML = `<span class="w-2 h-2 rounded-full ${dotColors[level]} flex-shrink-0" style="box-shadow: 0 0 5px ${dotShadows[level]}"></span><span class="text-slate-400">${time}</span><span class="flex-1">${message}</span>`;
                if (level === 'warn' || level === 'error' || level === 'critical') {
                    const anomalyIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="inline-block ml-auto text-slate-500 hover:text-cyan-300 cursor-pointer transition-colors" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-1.057 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/></svg>`;
                    entryHTML += `<span class="anomaly-explainer" data-message="${message}">${anomalyIcon}</span>`;
                }
                li.innerHTML = entryHTML;
                elements.activityLog.prepend(li);
                const explainer = li.querySelector('.anomaly-explainer');
                if (explainer) {
                    explainer.addEventListener('click', (e) => {
                        e.stopPropagation();
                        getAnomalyExplanation(explainer.dataset.message);
                    });
                }
                if (elements.activityLog.children.length > 15) { elements.activityLog.lastElementChild.remove(); }
            }

            function createBlips() { /* ... bez změny ... */ }

            function updateThreatLevel() {
                currentThreatIndex = (currentThreatIndex + 1) % threatLevels.length;
                const newThreat = threatLevels[currentThreatIndex];
                elements.threatPill.textContent = `HROZBA: ${newThreat.name}`;
                elements.threatPill.className = `threat-pill text-black font-bold text-sm py-1.5 px-4 rounded-full font-orbitron ${newThreat.class}`;
                elements.targetThreatPill.textContent = `STUPEŇ OHROŽENÍ: ${newThreat.name}`;
                elements.targetThreatPill.className = `mt-2 threat-pill text-black text-xs font-bold py-1 px-3 rounded-full inline-block ${newThreat.class}`;
                elements.aiAnalysisButton.classList.toggle('hidden', newThreat.level < 2);
                if (newThreat.level === 3) {
                    addLogEntry('Detekována kritická hrozba!', 'critical');
                    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                }
            }

            function simulateDataFlux() {
                elements.statBpm.textContent = randomInt(75, 110);
                elements.statRisk.textContent = `${randomInt(15, 40)}%`;
            }

            function runScanSequence() {
                if (isScanning) return;
                isScanning = true;
                elements.scanButton.disabled = true;
                elements.scanButton.textContent = 'PROBÍHÁ SKEN...';
                elements.scannerStatus.textContent = 'SKENOVÁNÍ...';
                elements.scannerSubtext.textContent = 'Analyzuji signály...';
                elements.scannerContainer.classList.add('animate-pulse-fast');
                addLogEntry('Inicializován sken...', 'info');
                if (navigator.vibrate) navigator.vibrate(50);
                const fluxInterval = setInterval(simulateDataFlux, 400);
                setTimeout(() => {
                    clearInterval(fluxInterval);
                    isScanning = false;
                    elements.scanButton.disabled = false;
                    elements.scanButton.textContent = 'INICIALIZOVAT SKEN';
                    elements.scannerStatus.textContent = 'PŘIPRAVEN';
                    elements.scannerSubtext.textContent = 'Čekám na příkaz';
                    elements.scannerContainer.classList.remove('animate-pulse-fast');
                    addLogEntry('Sken dokončen. Systém připraven.', 'info');
                    if (navigator.vibrate) navigator.vibrate([20, 50, 20]);
                }, 4000);
            }

            function showModal(title) {
                elements.modalTitle.textContent = title;
                elements.modalContent.innerHTML = '';
                elements.modalLoader.classList.remove('hidden');
                elements.aiModal.classList.remove('hidden');
                setTimeout(() => elements.aiModal.style.opacity = '1', 10);
            }

            function hideModal() {
                elements.aiModal.style.opacity = '0';
                setTimeout(() => elements.aiModal.classList.add('hidden'), 300);
            }

            async function callGeminiAPI(prompt) {
                const apiKey = ""; // Klíč je doplněn automaticky v prostředí
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error(`Chyba API: ${response.statusText}`);
                const result = await response.json();
                return result.candidates[0].content.parts[0].text;
            }

            async function getThreatAnalysis() {
                addLogEntry('Vyžádána taktická analýza...', 'ai');
                showModal('AI TAKTICKÁ ANALÝZA');
                const currentThreat = threatLevels[currentThreatIndex];
                const prompt = `Jsi expert na bezpečnostní analýzu ve futuristickém sci-fi světě. Detekoval jsi hrozbu. Cíl je 'Subjekt KAPPA-7'. Úroveň hrozby: '${currentThreat.name}'. Data: BPM: ${elements.statBpm.textContent}, Riziko: ${elements.statRisk.textContent}. Stručně (max 3 věty) vygeneruj taktickou analýzu a doporuč okamžité kroky. Odpověz česky.`;
                try {
                    elements.modalContent.innerText = await callGeminiAPI(prompt);
                    addLogEntry('AI analýza přijata.', 'ai');
                } catch (error) {
                    elements.modalContent.innerText = `Chyba: Nepodařilo se načíst analýzu. ${error.message}`;
                    addLogEntry('Chyba při komunikaci s AI modulem.', 'error');
                } finally {
                    elements.modalLoader.classList.add('hidden');
                }
            }
            
            async function getSubjectProfile() {
                addLogEntry('Vyžádán profil subjektu...', 'profile');
                showModal('PROFIL SUBJEKTU: KAPPA-7');
                const prompt = `Jsi AI analytik v tajné vesmírné agentuře. Tvým úkolem je vytvořit stručný, ale poutavý fiktivní profil pro 'Subjekt KAPPA-7'. Zahrň informace o jeho původu (např. geneticky modifikovaný, kyborg, mimozemšťan?), klíčových schopnostech (např. psionické síly, nadlidská síla, expert na infiltraci) a možných motivacích nebo slabinách. Udržuj tón profesionální, ale napínavý, jako by šlo o tajnou zprávu. Odpověz česky v odstavcích.`;
                try {
                    const profileText = await callGeminiAPI(prompt);
                    elements.modalContent.innerHTML = profileText.replace(/\n/g, '<br><br>');
                    addLogEntry('Profil subjektu úspěšně vygenerován.', 'profile');
                } catch (error) {
                    elements.modalContent.innerText = `Chyba: Nepodařilo se vygenerovat profil. ${error.message}`;
                    addLogEntry('Chyba při generování profilu.', 'error');
                } finally {
                    elements.modalLoader.classList.add('hidden');
                }
            }

            async function getAnomalyExplanation(logMessage) {
                addLogEntry(`Vyžádáno vysvětlení pro: "${logMessage}"`, 'ai');
                showModal('AI VYSVĚTLENÍ ANOMÁLIE');
                const prompt = `Jsi AI palubního počítače ve sci-fi lodi. Operátor v logu vidí zprávu: "${logMessage}". Poskytni krátké, kreativní, fiktivní vysvětlení, co by tato technická anomálie mohla znamenat v kontextu vesmírné mise. Udržuj profesionální, ale napínavý tón. Odpověz česky.`;
                try {
                    elements.modalContent.innerText = await callGeminiAPI(prompt);
                    addLogEntry('Vysvětlení anomálie přijato.', 'ai');
                } catch (error) {
                    elements.modalContent.innerText = `Chyba: Nepodařilo se načíst vysvětlení. ${error.message}`;
                    addLogEntry('Chyba při komunikaci s AI modulem.', 'error');
                } finally {
                    elements.modalLoader.classList.add('hidden');
                }
            }

            elements.scanButton.addEventListener('click', runScanSequence);
            elements.aiAnalysisButton.addEventListener('click', getThreatAnalysis);
            elements.profileButton.addEventListener('click', getSubjectProfile);
            elements.modalCloseButton.addEventListener('click', hideModal);
            elements.aiModal.addEventListener('click', (e) => { if(e.target === elements.aiModal) hideModal(); });

            function init() {
                createBlips();
                addLogEntry('Systém online. Všechny moduly načteny.', 'info');
                setTimeout(() => {
                    addLogEntry('Kolísání energetického štítu', 'warn');
                }, 2500);
                setInterval(createBlips, 5000);
                setInterval(updateThreatLevel, 8000);
            }
            init();
        });
    </script>
</body>
</html>