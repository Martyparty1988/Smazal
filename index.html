<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Najdi sma≈æ√°k v3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-gradient-start: #0a192f; --bg-gradient-mid: #0d4e5a; --bg-gradient-end: #4a0e4e;
            --accent-blue: #00f6ff; --accent-purple: #a855f7; --accent-yellow: #facc15;
            --accent-orange: #fb923c; --accent-red: #f87171; --accent-green: #4ade80;
            --text-primary: #e2e8f0; --text-secondary: #94a3b8;
            --glass-bg: rgba(28, 37, 61, 0.6); --glass-border: rgba(100, 116, 139, 0.25);
            --glow-blue: rgba(0, 246, 255, 0.35); --glow-purple: rgba(168, 85, 247, 0.4);
            --glow-yellow: rgba(250, 204, 21, 0.4); --glow-red: rgba(248, 113, 113, 0.5);
            --safe-area-top: env(safe-area-inset-top); --safe-area-bottom: env(safe-area-inset-bottom);
        }
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: 'Share Tech Mono', monospace;
            background: linear-gradient(160deg, var(--bg-gradient-start) 0%, var(--bg-gradient-mid) 50%, var(--bg-gradient-end) 100%);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
            margin: 0;
            padding: 0;
        }
        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 800"><rect fill="%230a192f" width="800" height="800"/><g fill-opacity="0.1"><circle fill="%230d4e5a" cx="400" cy="400" r="600"/><circle fill="%231d3b5f" cx="400" cy="400" r="500"/><circle fill="%230a192f" cx="400" cy="400" r="300"/><circle fill="%231d3b5f" cx="400" cy="400" r="200"/><circle fill="%234a0e4e" cx="400" cy="400" r="100"/></g></svg>');
            opacity: 0.05; pointer-events: none; z-index: -1;
        }
        h1, h2, h3, .font-orbitron { font-family: 'Orbitron', sans-serif; text-shadow: 0 0 8px var(--glow-blue); }
        .glass-panel {
            background: var(--glass-bg); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border); border-radius: 24px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        }
        .scanner-pulse {
            position: absolute; border-radius: 50%; border: 1px solid var(--accent-blue);
            animation: pulse 4s infinite cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 25px 5px var(--glow-blue), inset 0 0 20px 3px var(--glow-blue);
        }
        .scanner-pulse:nth-child(2) { animation-delay: 1.33s; }
        .scanner-pulse:nth-child(3) { animation-delay: 2.66s; }
        .animate-pulse-fast .scanner-pulse { animation-duration: 1.5s; }
        @keyframes pulse { 0% { transform: scale(0.1); opacity: 0; } 70% { opacity: 0.5; } 100% { transform: scale(1); opacity: 0; } }
        .blip {
            position: absolute; border-radius: 50%; background-color: var(--accent-blue);
            box-shadow: 0 0 12px 3px var(--glow-blue); animation: fade-in-out 3.5s infinite alternate ease-in-out; opacity: 0;
        }
        @keyframes fade-in-out { 0%, 100% { opacity: 0; transform: scale(0.4); } 50% { opacity: 0.8; transform: scale(1); } }
        .btn { transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        .btn:active:not(:disabled) { transform: scale(0.98); }
        .btn:disabled { cursor: not-allowed; filter: grayscale(80%); opacity: 0.7; }
        .btn-scan { background: linear-gradient(45deg, var(--accent-blue), var(--accent-purple)); box-shadow: 0 0 25px 5px var(--glow-blue); }
        .btn-scan:hover:not(:disabled) { box-shadow: 0 0 35px 8px var(--glow-purple); }
        .btn-scan:active:not(:disabled) { box-shadow: 0 0 20px 2px var(--glow-purple); }
        .btn-ai { background: linear-gradient(45deg, var(--accent-yellow), var(--accent-orange)); box-shadow: 0 0 20px 4px var(--glow-yellow); }
        .btn-ai:hover:not(:disabled) { box-shadow: 0 0 30px 7px var(--glow-yellow); }
        .btn-profile { background: linear-gradient(45deg, var(--accent-blue), #38bdf8); box-shadow: 0 0 20px 4px var(--glow-blue); }
        .btn-profile:hover:not(:disabled) { box-shadow: 0 0 30px 7px var(--glow-blue); }
        .threat-pill { transition: all 0.5s ease; }
        .threat-low { background-color: var(--accent-green); box-shadow: 0 0 12px var(--accent-green); }
        .threat-medium { background-color: var(--accent-yellow); box-shadow: 0 0 12px var(--accent-yellow); }
        .threat-high { background-color: var(--accent-orange); box-shadow: 0 0 12px var(--accent-orange); }
        .threat-critical { background-color: var(--accent-red); box-shadow: 0 0 15px var(--glow-red); animation: pulse-red 1.5s infinite; }
        #ai-modal { transition: opacity 0.3s ease; }
        .ai-modal-loader {
            width: 50px; height: 50px; border: 4px solid var(--glass-border);
            border-top-color: var(--accent-blue); border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .flash-red { animation: red-flash 0.5s ease-out; }
        @keyframes red-flash { 0%, 100% { box-shadow: none; } 50% { box-shadow: inset 0 0 100px 50px rgba(248, 113, 113, 0.6); } }
        @keyframes pulse-red { 0% { transform: scale(1); box-shadow: 0 0 15px var(--glow-red); } 50% { transform: scale(1.03); box-shadow: 0 0 22px var(--glow-red); } 100% { transform: scale(1); box-shadow: 0 0 15px var(--glow-red); } }
        
        .main-container {
            max-width: 480px;
            margin: 0 auto;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: calc(var(--safe-area-top) + 0.5rem) 1rem calc(var(--safe-area-bottom) + 0.5rem);
            box-sizing: border-box;
        }
        .radar-container {
            flex-shrink: 0;
            width: 60vw;
            max-width: 280px;
            aspect-ratio: 1/1;
            margin: 0.5rem auto;
        }
        .info-panel {
            min-height: 0;
        }
        #activity-log {
            height: 100%;
        }

        @media (prefers-reduced-motion: reduce) {
          .scanner-pulse, .blip, .btn, .threat-pill, .flash-red, .threat-critical { animation: none !important; transition-duration: 0.01ms !important; }
        }
    </style>
</head>
<body class="bg-gray-900">

    <div class="main-container space-y-2 sm:space-y-3">
        
        <h1 class="font-orbitron text-2xl sm:text-3xl text-center text-cyan-300 flex-shrink-0">Najdi sma≈æ√°k v3.0</h1>

        <header class="flex justify-between items-center px-2 z-10 flex-shrink-0">
            <div id="threat-level-pill" class="threat-pill threat-low text-black font-bold text-xs py-1.5 px-3 rounded-full font-orbitron text-center">Na pohodu</div>
        </header>

        <div class="radar-container relative flex items-center justify-center">
            <div id="scanner-visual" class="absolute w-full h-full rounded-full">
                <div id="scanner-container" class="absolute w-full h-full">
                    <div class="scanner-pulse w-full h-full"></div>
                    <div class="scanner-pulse w-full h-full"></div>
                    <div class="scanner-pulse w-full h-full"></div>
                </div>
            </div>
            <div class="font-orbitron text-center z-10">
                <div id="scanner-status" class="text-2xl sm:text-3xl font-bold text-cyan-300 transition-all" style="text-shadow: 0 0 15px var(--glow-blue);">HOTOVEJ NA ≈†LEH</div>
                <div id="scanner-subtext" class="text-xs sm:text-sm text-slate-400 transition-all">ƒåek√°m na lajnu</div>
            </div>
        </div>

        <button id="scan-button" class="btn btn-scan w-full p-3 rounded-full text-lg font-orbitron font-bold text-black tracking-wider flex-shrink-0">≈†LEHNOUT D√ÅVKU</button>

        <div class="glass-panel p-3 sm:p-4 info-panel">
            <div class="flex justify-between items-center mb-2">
                <h3 class="font-orbitron text-base">ROZBOR MATRO≈†E</h3>
                <button id="profile-button" class="btn btn-profile px-3 py-1 rounded-full text-xs font-orbitron font-bold text-black">KDO JE TEN SMA≈ΩKA?</button>
            </div>
            <div class="flex items-center space-x-3">
                <div class="w-14 h-14 sm:w-16 sm:h-16 rounded-full border-2 border-cyan-400 shadow-lg flex-shrink-0" style="box-shadow: 0 0 15px var(--glow-blue);">
                    <svg id="subject-avatar" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="50" cy="50" r="48" stroke="var(--accent-blue)" stroke-width="2"/><path d="M50 30C58.2843 30 65 36.7157 65 45C65 53.2843 58.2843 60 50 60C41.7157 60 35 53.2843 35 45C35 36.7157 41.7157 30 50 30Z" stroke="var(--accent-blue)" stroke-width="2"/><path d="M25 85C25 73.9543 36.1929 65 50 65C63.8071 65 75 73.9543 75 85" stroke="var(--accent-blue)" stroke-width="2" stroke-linecap="round"/>
                        <text id="subject-avatar-text" x="50" y="52" font-family="Orbitron, sans-serif" font-size="18" fill="var(--accent-blue)" text-anchor="middle" dominant-baseline="middle">≈†LEHA≈ò</text>
                    </svg>
                </div>
                <div class="flex-1 min-w-0">
                    <div id="subject-name" class="font-bold text-base sm:text-lg truncate">≈†leha≈ô Delta-Piko</div>
                    <div id="target-status" class="text-xs text-slate-400">Stav: Relativnƒõ v klidu</div>
                    <div id="target-threat-pill" class="mt-1 threat-pill threat-low text-black text-xs font-bold py-1 px-2 rounded-full inline-block text-center">Na pohodu</div>
                </div>
            </div>
             <div class="grid grid-cols-2 gap-2 text-center text-xs mt-2">
                <div class="glass-panel p-1 rounded-lg"><div id="stat-bpm" class="font-bold text-base text-yellow-400">82</div><div>TEP√çK</div></div>
                <div class="glass-panel p-1 rounded-lg"><div id="stat-risk" class="font-bold text-base text-yellow-400">18%</div><div class="leading-tight">≈†ANCE ≈ΩE RUPNE ≈Ω√çLA</div></div>
            </div>
            <button id="ai-analysis-button" class="btn btn-ai w-full p-2 mt-2 rounded-full text-sm font-orbitron font-bold text-black tracking-wider hidden">‚ú® PORADIT SE S DEALEREM</button>
        </div>

        <div class="glass-panel p-3 sm:p-4 flex flex-col min-h-0 flex-grow">
            <h3 class="font-orbitron text-base mb-2 flex-shrink-0">Z√ÅPISKY ZE DNA</h3>
            <ul id="activity-log" class="space-y-2 text-xs overflow-y-auto pr-2 flex-grow"></ul>
        </div>
    </div>

    <div id="ai-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="glass-panel w-full max-w-lg p-6 relative">
            <button id="modal-close-button" class="absolute top-4 right-4 text-slate-400 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708 .708L8.707 8l2.647 2.646a.5.5 0 0 1-.708 .708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
            </button>
            <h3 id="modal-title" class="font-orbitron text-xl mb-4 text-cyan-300"></h3>
            <div id="modal-content" class="text-slate-300 leading-relaxed max-h-[60vh] overflow-y-auto"></div>
            <div id="modal-loader" class="w-full flex justify-center items-center py-8 hidden"><div class="ai-modal-loader"></div></div>
        </div>
    </div>
    
    <div id="event-overlay" class="hidden fixed inset-0 bg-red-900/70 backdrop-blur-sm flex items-center justify-center z-[100] text-white font-orbitron text-7xl md:text-9xl text-center p-4" style="text-shadow: 0 0 25px #fff, 0 0 50px red;">
        Z√ÅTAH!
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const elements = {
                scannerVisual: document.getElementById('scanner-visual'),
                scannerContainer: document.getElementById('scanner-container'),
                threatPill: document.getElementById('threat-level-pill'),
                scanButton: document.getElementById('scan-button'),
                scannerStatus: document.getElementById('scanner-status'),
                scannerSubtext: document.getElementById('scanner-subtext'),
                activityLog: document.getElementById('activity-log'),
                statBpm: document.getElementById('stat-bpm'),
                statRisk: document.getElementById('stat-risk'),
                aiAnalysisButton: document.getElementById('ai-analysis-button'),
                profileButton: document.getElementById('profile-button'),
                aiModal: document.getElementById('ai-modal'),
                modalTitle: document.getElementById('modal-title'),
                modalContent: document.getElementById('modal-content'),
                modalLoader: document.getElementById('modal-loader'),
                modalCloseButton: document.getElementById('modal-close-button'),
                targetThreatPill: document.getElementById('target-threat-pill'),
                subjectName: document.getElementById('subject-name'),
                subjectAvatarText: document.getElementById('subject-avatar-text'),
                eventOverlay: document.getElementById('event-overlay'),
            };

            let isScanning = false;
            let isEventActive = false;
            let currentThreatIndex = 0;
            let currentSubject = null;
            
            let soundsReady = false;
            const sounds = {
                click: new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.05, release: 0.1 } }).toDestination(),
                log: new Tone.MembraneSynth({ pitchDecay: 0.008, octaves: 2, envelope: { attack: 0.001, decay: 0.2, sustain: 0.01 } }).toDestination(),
                scan: new Tone.NoiseSynth({ noise: { type: 'pink' }, envelope: { attack: 0.01, decay: 1.5, sustain: 0 } }).toDestination(),
                alarm: new Tone.Synth({ oscillator: { type: 'sawtooth' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.3 } }).toDestination(),
                raid: new Tone.Synth({ oscillator: { type: 'fatsawtooth', count: 3, spread: 30 }, envelope: { attack: 0.01, decay: 1, sustain: 0.2, release: 0.5 } }).toDestination()
            };
            sounds.log.volume.value = -10;
            sounds.scan.volume.value = -20;
            
            async function initializeAudio() {
                if (soundsReady) return;
                try {
                    await Tone.start();
                    soundsReady = true;
                    console.log('Audio context spu≈°tƒõn.');
                } catch (e) {
                    console.error("Chyba p≈ôi inicializaci audia:", e);
                }
            }

            // --- NOV√Å DATAB√ÅZE POSTAV ---
            const state = {};
            state.subjects = [
                { id: 'slehac', name: '≈†leha≈ô Delta-Piko', avatar: '≈†LEHA≈ò', profile: 'P≈Øvod: Uliƒçn√≠ varna v ≈Ωi≈ækovƒõ. Schopnosti: Pozn√° fe≈•√°ka na 200 metr≈Ø. Slabiny: Boj√≠ se holub≈Ø.', logPhrases: ['Va≈ô√≠m d√°vku, dr≈æ se', '≈†leh√°m vrstviƒçku I', 'Dealer hl√°s√≠, ≈æe zbo≈æ√≠ jede', 'Piko ƒçistota 78 %, dobr√Ω', 'P≈ôipravuju st≈ô√≠kaƒçku', 'V√°ha ukazuje p≈ôesnƒõ, dneska to bude j√≠zda.', 'Filtruju p≈ôes cigaretu, klasika.', 'Kyselina se odpa≈ôuje, cejt√≠≈° to?', 'Bacha, a≈• to nezcukernat√≠.', 'Zrc√°tko je ƒçist√Ω, lajna p≈ôipravena.', 'Tep stoup√°, zorniƒçky jak tal√≠≈ôe.', 'Pr√°vƒõ jsem prodal star√Ω r√°dio za gram.'] },
                { id: 'hulic', name: 'Huliƒç Zubat√° ≈Ω√°rovka', avatar: 'HULIƒå', profile: 'P≈Øvod: Sklen√≠k za panel√°kem. Schopnosti: Um√≠ ubalit brko i poslepu. Slabiny: Neust√°le se smƒõje vlastn√≠m vtip≈Øm.', logPhrases: ['P≈ôepaluju sklo', 'U≈æ to bubl√°, k√°mo', 'M√°m tot√°ln√≠ ƒçerven√Ω oƒçi', 'Kde je zapalovaƒç?', 'Tohle je silnej model', 'Tenhle model lep√≠ prsty, to je dob≈ôe.', 'Sh√°n√≠m pap√≠rky, do≈°ly mi.', '≈Ω√°rovka p≈ôipravena k vaporizaci.', 'M√°m vlƒç√≠ hlad, objedn√°v√°m pizzu.', 'Kde m√°m drtiƒçku? Zase jsem ji ztratil.', 'Tohle je sativka, nebo indika? U≈æ nev√≠m.', 'Pou≈°t√≠m si chill-out mix, a≈• to m√° atmosf√©ru.'] },
                { id: 'cichac', name: 'ƒåichaƒç Trubek Omega', avatar: 'ƒåICHAƒå', profile: 'P≈Øvod: Kan√°ly pod hlavn√≠m n√°dra≈æ√≠m. Schopnosti: Pozn√° znaƒçku ≈ôedidla po ƒçichu. Slabiny: ƒåasto mluv√≠ s odpadkov√Ωmi ko≈°i.', logPhrases: ['ƒåich√°m toluen z hadru', 'Tohle lepidlo je top', 'Mozek mi odch√°z√≠ na v√Ωlet', 'Kde je ta igelitka?', 'V≈°echno se toƒç√≠', 'Dneska testuju novej druh ≈ôedidla.', 'Vzpom√≠nky se rozmaz√°vaj, barvy jsou hezƒç√≠.', 'Ten igeli≈•√°k u≈æ m√° d√≠ru, pot≈ôebuju novej.', 'Sly≈°√≠m ozvƒõny z kan√°lu, asi na mƒõ mluv√≠.', 'Tohle je lep≈°√≠ ne≈æ vo≈àavej stromeƒçek.', 'Ztr√°c√≠m pojem o ƒçase... a o prostoru.', 'K√°mo, p≈Øjƒç mi hadr, ten m≈Øj u≈æ je suchej.'] },
                { id: 'domingo', name: 'Domingo ze Sm√≠chova', avatar: 'DEALER', profile: 'P≈Øvod: Laviƒçka na Andƒõlu. Schopnosti: Dok√°≈æe prodat cokoliv komukoliv. Kvalita zbo≈æ√≠ je... promƒõnliv√°, ale obƒças m√° tak dobrej pern√≠k, ≈æe tƒõ vyst≈ôel√≠ z papuƒç√≠.', logPhrases: ['M√°m ƒçerstvej matro≈°, chce≈°?', 'Dneska akce, dva za cenu jednoho.', 'Bacha, za rohem stojej f√≠zlov√©.', 'Platba jen v hotovosti, k√°mo.', 'Tohle je ƒçist√Ω, p≈ô√≠sah√°m.', 'Zn√°≈° Pepu? Dlu≈æ√≠ mi prachy.', 'Pot≈ôebuju si rychle vydƒõlat na n√°jem.', 'Nekoukej tak n√°padnƒõ, nejsme tu sami.', 'Rychle, rychle, nem√°m ƒças.'] },
                { id: 'pedro', name: 'Pedro Pern√≠ƒçek', avatar: 'DOVOZ', profile: 'P≈Øvod: Nezn√°m√Ω, v≈ædy na cestƒõ. Schopnosti: Expresn√≠ doruƒçen√≠ a≈æ do domu 24/7. Slabiny: Obƒças si splete adresu.', logPhrases: ['Jsem na cestƒõ, ƒçekej.', 'U≈æ jsem za rohem, p≈ôiprav prachy.', 'M√°≈° p≈ôesnƒõ? Nem√°m na vr√°cen√≠.', 'Dneska m√°m zpo≈ædƒõn√≠, kolony.', 'Nov√° v√°rka, silnƒõj≈°√≠ ne≈æ minule.', 'Nezved√°≈° telefon, co se dƒõje?', 'Stoj√≠m p≈ôed bar√°kem, kde jsi?', 'Dneska jen pern√≠k, nic jin√Ωho nem√°m.', 'Bonusovej gram za vƒõrnost.'] },
                { id: 'chemik', name: 'Chemik z V≈†CHT', avatar: 'CHEMIK', profile: 'P≈Øvod: Laborato≈ô v Dejvic√≠ch. Schopnosti: Syntetizuje s p≈ôesnost√≠ na mikrogram. Slabiny: Pot≈ôebuje absolutn√≠ ticho a k√°vu.', logPhrases: [] },
                { id: 'dispecer', name: 'Dispeƒçer S√≠tƒõ', avatar: 'DISPEƒåER', profile: 'P≈Øvod: Anonymn√≠ serverovna. Schopnosti: Koordinuje logistiku cel√© s√≠tƒõ bez jedin√© chyby. Slabiny: Nikdy neopou≈°t√≠ sv√© k≈ôeslo.', logPhrases: [] }
            ];

            const extraPhrases = {
                slehac: {
                    toastPhrases: ['ƒåistota nad 80 %. Le≈•.','Filtr ƒçist√Ω. Nezakecej.','M√≠ch√°m to jak bo≈æ√≠ prst.','Teplota dr≈æ√≠. Nep≈ôepal.','Vzorek stabiln√≠. Plynule.','Synt√©za v pln√Ωm proudu.','Bez bublin. Profi kvalita.','Mix jak od Michelina.','Krystal jak diamant.','Tlak dr≈æ√≠. Nemƒõ≈à nic.'],
                    logPhrases: ['Zkumavka zp√≠v√° ‚Äì ƒçist√Ω t√≥n.','Mikro bubliny OK.','Mƒõ≈ô√°k blik√° zelenƒõ.','Destilku dol√≠t, a≈• to ne≈°kr√°be.','M√≠chadlo v rytmu, dr≈æ tempo.','Povrch zrcadlo, bez puch√Ω≈ô≈Ø.','PH cajk, m≈Ø≈æeme p≈ôitopit.','V≈Ønƒõ plastu miz√≠ ‚Äì dobr√Ω sign√°l.','N√°lev bez kalu ‚Äì par√°da.','Laborato≈ô bƒõ≈æ√≠ jak hodinky.','Tepeln√° k≈ôivka ide√°ln√≠.','Nic se nep≈ôipaluje ‚Äì top stav.']
                },
                hulic: {
                    toastPhrases: ['T√°hne to. Dr≈æ linku.','Popel si sed√°. Klid.','Sklo ƒçist√Ω. Respekt.','Seshni to na ≈°piƒçku.','Vlhkej ka≈°el? Voda, k√°mo.','Plamen h≈ôeje akor√°t.','T√°hni pomalu. A≈• to dr≈æ√≠.','Chu≈• jak prvn√≠ l√°ska.','≈Ω√°r rovnomƒõrnej.','Popeln√≠k v limitu.'],
                    logPhrases: ['Zapal z boku, a≈• to nefouk√°.','Filtr se nechyt√° ‚Äì luxus.','Kruh jak vinyl, star√° ≈°kola.','S√≠dlo prachu: podlo≈æka.','Nehro≈• tah, nech to d√Ωchat.','Aroma citrus-beton. Mmm.','Plamen mal√Ω, √∫sporn√Ω m√≥d.','Kou≈ô ƒçistej jak horskej vzduch.','≈Ω√°r bez prask√°n√≠.','Sklo se leskne jak nov√Ω.','Pocit lehkosti ‚Äì ide√°l.','≈†luk jak z uƒçebnice.']
                },
                cichac: {
                    toastPhrases: ['Hadr ready. Film bƒõ≈æ√≠.','Vdechni. Nep≈ôeh√°nƒõj.','Profil dr≈æ√≠. Barviƒçky.','V√≠ƒçko tƒõsn√≠. Kl√≠dek.','Kanystr mlƒç√≠. Zat√≠m.','V≈Ønƒõ se l√°me do sladka.','Vzduch m√° jiskru.','Film bez bublin.','Parf√©m tov√°rny. Deluxe.','Tlak von√≠ stabilnƒõ.'],
                    logPhrases: ['Vzduch se krout√≠ jak had.','Ticho v u≈°√≠ch ‚Äì j√≠zda.','Stromek v autƒõ? Ubohost.','Z√°van fabriky ‚Äì nostalgie.','ƒåas gumovej. P≈ôist√°vej pomalu.','Molekuly tanƒç√≠ ve spir√°le.','Nos brn√≠, to je ono.','Filtr dr≈æ√≠ v≈Øni pevnƒõ.','Hlavn√≠ aroma stabiln√≠.','Lehk√° pachu≈• chemie ‚Äì cajk.','Bublina ƒçasu, nic se neh√Ωbe.','Vzorek v limitu, m≈Ø≈æe≈° jet.']
                },
                domingo: {
                    toastPhrases: ['P≈ôed√°vka v tichu.','Kamera za rohem. Bacha.','Bal√≠ƒçek nen√°padnej.','Okno otev≈ôen√Ω minutu.','ƒåas jsou prachy.','St√≠n mƒõ kryje.','Z√≥na ƒçist√°.','Pohyb minim√°ln√≠.','Kontakt potvrzen.','Stopy vymaz√°ny.'],
                    logPhrases: ['Koridor ƒçist√Ω, jdeme.','Pl√°≈°≈• ≈°ust√≠ ‚Äì sign√°l.','Stopy sma≈æ, kdy≈æ odch√°z√≠≈°.','Telefon do kapsy, teƒè.','Zpƒõtn√° kontrola: nikdo za n√°ma.','Vchod chr√°nƒõn, klid.','Nabit√Ω pl√°n, jedeme d√°l.','Bez zbyteƒçn√Ωch slov.','Otoƒçka za roh a pryƒç.','Klidn√° z√≥na, ≈æ√°dn√Ω svƒõdci.','Doruƒçeno bez komplikac√≠.','Ob√°lka v bezpeƒç√≠.']
                },
                pedro: {
                    toastPhrases: ['Brzd√≠m. Br√°na?','Obj√≠≈æƒèka hotov√°.','Zvon√≠m a miz√≠m.','Expres re≈æim.','Bal√≠k vakuuju.','P≈ôed domem za 2 minuty.','Parkuju vedle hydrantu.','N√°klad dr≈æ√≠ pevnƒõ.','Bez zast√°vky. Turbo.','Zat√°ƒçka a jsem tam.'],
                    logPhrases: ['Byt vlevo, t≈ôet√≠ zvonek.','Kolona na Barrandovƒõ ‚Äì zpo≈æƒèuju.','Parkuju u hydrantu, fofr.','V kufru to dr≈æ√≠ ‚Äì ≈æ√°dn√Ω ≈°ust.','GPS hops√°, jsem bl√≠zko.','Svƒõtla zhasnut√°, klidn√° p≈ô√≠jezdovka.','Dod√°vka maskovan√° v kolonƒõ.','ƒåas p≈ô√≠jezdu p≈ôesnej na vte≈ôinu.','V√Ωjezd bez pozornosti okol√≠.','Doruƒçeno a odjeto.','Zpo≈ædƒõn√≠ minimalizov√°no.','Trasa vyƒçi≈°tƒõn√°.']
                },
                chemik: {
                    toastPhrases: ['Reakce stabiln√≠.','Vzorek pod kontrolou.','Teplota dr≈æ√≠ ¬±0,1¬∞C.','PH p≈ôesnƒõ v normƒõ.','Anal√Ωza bƒõ≈æ√≠.','Bezpeƒçn√Ω roztok p≈ôipraven.','Testovac√≠ s√©rie dokonƒçena.','P≈ôesnƒõ odmƒõ≈ôeno.','Vzorek ƒçist√Ω jako slovo Bo≈æ√≠.','Laborato≈ô v zelen√Ωch ƒç√≠slech.'],
                    logPhrases: ['Titraƒçn√≠ k≈ôivka perfektn√≠.','Mƒõ≈ôen√≠ p≈ôesn√© na mikron.','≈Ω√°dn√° sedimentace.','Odpar 0,02 % ‚Äì ide√°l.','Spektrum bez ≈°umu.','Z√°znam ulo≈æen do protokolu.','Reaktor stabiln√≠.','V√Ωsledek potvrzen duplik√°tem.','Kalibrace 100 %. Hotovo.','ƒåas do dal≈°√≠ reakce: 3 min.','≈Ω√°dn√© odchylky nenalezeny.','Parametry v normƒõ.']
                },
                dispecer: {
                    toastPhrases: ['Trasa potvrzen√°.','C√≠l v dosahu.','Dal≈°√≠ zast√°vka p≈ôipravena.','Okno pro p≈ôesun otev≈ôen√©.','Bezpeƒçn√Ω koridor aktivn√≠.','P≈ô√≠jezd podle pl√°nu.','V≈°echny jednotky v pozici.','Synchronizace hotov√°.','P≈ôesmƒõrov√°n√≠ bez zdr≈æen√≠.','ƒåasov√° rezerva +2 min.'],
                    logPhrases: ['Satelitn√≠ sn√≠mek ovƒõ≈ôen.','≈Ω√°dn√© p≈ôek√°≈æky na trase.','P≈ôekresluju mapu pohybu.','Nov√Ω bod z√°jmu p≈ôid√°n.','C√≠lov√° z√≥na ƒçist√°.','P≈ôed√°v√°m sou≈ôadnice.','Radiov√Ω kontakt nav√°z√°n.','Pl√°n B p≈ôipraven.','Synchronizace t√Ωm≈Ø dokonƒçena.','Sign√°l 100 %, spojen√≠ stabiln√≠.','ƒåasov√° osa aktualizov√°na.','Bezpeƒçn√Ω pr≈Øchod potvrzen.']
                }
            };
            // --- KONEC DATAB√ÅZE ---

            const genericLogPhrases = [
                "F√≠zlov√© se motaj pobl√≠≈æ", "Krev√°k ti let√≠, tep√≠k: {BPM}", "Riziko prasknut√≠ ≈æ√≠ly: {RISK}%", "Schovej se, jede mƒõ≈°≈•√°k",
                "≈†≈àupu data z radaru", "Tep ti l√≠t√° jak kolotoƒç", "Sjet√Ω, ale pod kontrolou", "K√°mo, m√°≈° rozta≈æen√Ω zorniƒçky",
                "Tv≈Øj tep√≠k: {BPM}, to je cajk", "Tv≈Øj tep√≠k: {BPM}, u≈æ jsi p≈ôest≈ôelil", "Prasklo tƒõlo na ≈°rot",
                "Dealer offline, improvizuj", "Nƒõkdo ≈•uk√° na dve≈ôe", "Vysok√Ω tlak, k√°mo", "F√≠zlov√© na st≈ôe≈°e",
                "K√°mo, jsi b√≠lej jak stƒõna", "Sousedka zase ƒçum√≠ z okna", "Ztr√°c√≠m sign√°l... ru≈°en√≠",
                "Srdce bu≈°√≠ jako na teknu.", "Vid√≠m zvuky a sly≈°√≠m barvy.", "Syst√©m hl√°s√≠ nedostatek serotoninu.",
                "Tlak 200 na 150, pohoda jazz.", "Pot≈ôebuju cukr. Nebo piko. Oboj√≠.",
                "T≈ôesou se mi ruce, to je z hladu... asi.", "Realita je jen iluze zp≈Øsoben√° nedostatkem pern√≠ku."
            ];

            const threatLevels = [
                { name: 'Na pohodu, jen tro≈°ku sjet√Ω', class: 'threat-low', level: 0 },
                { name: 'P≈Øl d√°vky v ≈æ√≠le', class: 'threat-medium', level: 1 },
                { name: 'Na ≈°rot', class: 'threat-high', level: 2 },
                { name: 'Tot√°l Overdose', class: 'threat-critical', level: 3 }
            ];
            
            let lastUsedLog = '';

            const random = (min, max) => Math.random() * (max - min) + min;

            function getRandomLogPhrase() {
                if (!currentSubject) return "...";
                // Kombinace obecn√Ωch, postavov√Ωch a extra hl√°≈°ek
                const subjectSpecificLogs = currentSubject.logPhrases || [];
                const extraLogs = extraPhrases[currentSubject.id]?.logPhrases || [];
                const combinedPhrases = [...genericLogPhrases, ...subjectSpecificLogs, ...extraLogs];

                let availablePhrases = combinedPhrases.filter(p => p !== lastUsedLog);
                if (availablePhrases.length === 0) availablePhrases = combinedPhrases; // Reset if all used
                let phrase = availablePhrases[Math.floor(Math.random() * availablePhrases.length)];
                lastUsedLog = phrase;
                return phrase.replace('{BPM}', elements.statBpm.textContent).replace('{RISK}', elements.statRisk.textContent);
            }

            function addLogEntry(message, level = 'info') {
                if (soundsReady) sounds.log.triggerAttackRelease('C2', '8n');
                const li = document.createElement('li');
                li.className = 'flex items-start space-x-2 border-t border-slate-700/50 pt-2';
                const dotColors = { info: 'bg-green-400', warn: 'bg-yellow-400', error: 'bg-orange-400', critical: 'bg-red-400', ai: 'bg-purple-400', profile: 'bg-blue-400', event: 'bg-red-600' };
                const dotShadows = { info: 'var(--accent-green)', warn: 'var(--accent-yellow)', error: 'var(--accent-orange)', critical: 'var(--accent-red)', ai: 'var(--glow-purple)', profile: 'var(--glow-blue)', event: 'var(--glow-red)' };
                const time = new Date().toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                li.innerHTML = `<div class="flex-shrink-0 pt-1.5"><span class="w-2 h-2 rounded-full ${dotColors[level]} block" style="box-shadow: 0 0 5px ${dotShadows[level]}"></span></div><span class="text-slate-400">${time}</span><span class="flex-1">${message}</span>`;
                elements.activityLog.prepend(li);
                if (elements.activityLog.children.length > 20) { elements.activityLog.lastElementChild.remove(); }
            }
            
            function addRandomLog(level = 'info') {
                addLogEntry(getRandomLogPhrase(), level);
            }

            function createBlips() {
                if (isEventActive) return;
                const container = elements.scannerContainer;
                const blipCount = Math.floor(random(2, 5));
                container.querySelectorAll('.blip').forEach(b => b.remove());
                for (let i = 0; i < blipCount; i++) {
                    const blip = document.createElement('div');
                    blip.className = 'blip';
                    const size = random(6, 15);
                    blip.style.width = `${size}px`;
                    blip.style.height = `${size}px`;
                    blip.style.left = `${random(10, 90)}%`;
                    blip.style.top = `${random(10, 90)}%`;
                    blip.style.animationDelay = `${random(0, 2)}s`;
                    container.appendChild(blip);
                }
            }

            function changeSubject() {
                const newSubject = state.subjects[Math.floor(Math.random() * state.subjects.length)];
                currentSubject = newSubject;
                elements.subjectName.textContent = newSubject.name;
                elements.subjectAvatarText.textContent = newSubject.avatar;
            }

            function updateThreatLevel() {
                if (isScanning || isEventActive) return;
                currentThreatIndex = (currentThreatIndex + 1) % threatLevels.length;
                const newThreat = threatLevels[currentThreatIndex];
                
                const shortThreatName = newThreat.name.split(',')[0];
                elements.threatPill.textContent = shortThreatName;
                elements.targetThreatPill.textContent = shortThreatName;

                elements.threatPill.className = `threat-pill text-black font-bold text-xs py-1.5 px-3 rounded-full font-orbitron text-center ${newThreat.class}`;
                elements.targetThreatPill.className = `mt-1 threat-pill text-black text-xs font-bold py-1 px-2 rounded-full inline-block text-center ${newThreat.class}`;
                
                elements.aiAnalysisButton.classList.toggle('hidden', newThreat.level < 2);
                
                const logLevels = ['info', 'warn', 'error', 'critical'];
                addLogEntry(`‚ö†Ô∏è Hrozba: ${newThreat.name}`, logLevels[newThreat.level]);

                if (newThreat.level === 3) {
                    if (soundsReady) sounds.alarm.triggerAttackRelease('C5', '0.5s');
                    if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]);
                    elements.scannerVisual.classList.add('flash-red');
                    setTimeout(() => elements.scannerVisual.classList.remove('flash-red'), 500);
                }
            }

            function runScanSequence() {
                if (isScanning || isEventActive || !currentSubject) return;
                initializeAudio();
                if (soundsReady) sounds.scan.triggerAttackRelease("2n");

                isScanning = true;
                elements.scanButton.disabled = true;
                elements.scannerContainer.classList.add('animate-pulse-fast');
                
                const toastPhrases = extraPhrases[currentSubject.id]?.toastPhrases || ['SKENUJI... Pros√≠m ƒçekejte.'];
                let counter = 0;
                const scanDuration = 4;

                addRandomLog('info');
                const scanInterval = setInterval(() => {
                    if (isEventActive) {
                        clearInterval(scanInterval);
                        return;
                    }

                    const randomToast = toastPhrases[Math.floor(Math.random() * toastPhrases.length)];
                    const [status, subtext] = randomToast.split('. ');
                    elements.scannerStatus.textContent = status.toUpperCase();
                    elements.scannerSubtext.textContent = subtext || '...';
                    
                    elements.statBpm.textContent = Math.floor(random(70, 160));
                    elements.statRisk.textContent = `${Math.floor(random(10, 95))}`;
                    
                    counter++;
                    if (counter >= scanDuration) {
                        clearInterval(scanInterval);
                        elements.scannerStatus.textContent = 'HOTOVEJ NA ≈†LEH';
                        elements.scannerSubtext.textContent = 'ƒåek√°m na dal≈°√≠ lajnu';
                        elements.scanButton.disabled = false;
                        isScanning = false;
                        elements.scannerContainer.classList.remove('animate-pulse-fast');
                        addLogEntry('D√°vka ≈°lehnut√°, syst√©m ready.', 'info');
                        changeSubject();
                    }
                }, 1200);
            }
            
            function triggerPoliceRaid() {
                if (isEventActive || isScanning) return;
                isEventActive = true;
                
                if (soundsReady) sounds.raid.triggerAttackRelease("C3", "2s");
                if (navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 500]);

                elements.scanButton.disabled = true;
                elements.scannerStatus.textContent = "Z√ÅTAH!!!";
                elements.scannerSubtext.textContent = "F√çZLOV√â V≈†UDE KOLEM!";
                elements.eventOverlay.classList.remove('hidden');
                addLogEntry('üö®üö® Z√ÅTAH! V≈†ICHNI K ZEMI! üö®üö®', 'event');

                setTimeout(() => {
                    elements.eventOverlay.classList.add('hidden');
                    elements.scannerStatus.textContent = 'ƒåISTO... PROZAT√çM';
                    elements.scannerSubtext.textContent = 'Uklidni se a ƒçekej';
                    addLogEntry('Uf, byli to jenom plyna≈ôi.', 'info');
                    
                    setTimeout(() => {
                        isEventActive = false;
                        elements.scanButton.disabled = false;
                        elements.scannerStatus.textContent = 'HOTOVEJ NA ≈†LEH';
                        elements.scannerSubtext.textContent = 'ƒåek√°m na dal≈°√≠ lajnu';
                    }, 4000);

                }, 5000);
            }

            function tryRandomEvent() {
                if (Math.random() < 0.1) { // Sn√≠≈æen√° ≈°ance na 10%
                    triggerPoliceRaid();
                }
            }
            
            function autoLogQuip() {
                if (!isScanning && !isEventActive) {
                    addRandomLog('info');
                }
                const randomDelay = random(9000, 13000);
                setTimeout(autoLogQuip, randomDelay);
            }

            function showModal(title) {
                if (soundsReady) sounds.click.triggerAttackRelease('C4', '8n');
                elements.modalTitle.textContent = title;
                elements.modalContent.innerHTML = '';
                elements.modalLoader.classList.remove('hidden');
                elements.aiModal.classList.remove('hidden');
                setTimeout(() => elements.aiModal.style.opacity = '1', 10);
            }

            function hideModal() {
                if (soundsReady) sounds.click.triggerAttackRelease('A3', '8n');
                elements.aiModal.style.opacity = '0';
                setTimeout(() => elements.aiModal.classList.add('hidden'), 300);
            }

            function getThreatAnalysis() {
                addLogEntry('Pt√°m se dealera na radu...', 'ai');
                showModal('PORADNA OD DEALER≈Æ');
                setTimeout(() => {
                    elements.modalLoader.classList.add('hidden');
                    elements.modalContent.innerText = 'Dej si pauzu, k√°mo. Nep≈ôeh√°nƒõj to s lajnama. Tep m√°≈° jak po trojit√© d√°vce. Jestli chce≈° dal≈°√≠ matro≈°, nejd≈ô√≠v se vyspi a dej si vodu.';
                    addLogEntry('Dealer poslal zpr√°vu.', 'ai');
                }, 1500);
            }
            
            function getSubjectProfile() {
                if (!currentSubject) return;
                addLogEntry('Vytahuju info o sma≈æce...', 'profile');
                showModal(`KDO JE TEN SMA≈ΩKA: ${currentSubject.name.toUpperCase()}`);
                setTimeout(() => {
                    elements.modalLoader.classList.add('hidden');
                    elements.modalContent.innerHTML = currentSubject.profile.replace(/\. /g, '.<br><br>');
                    addLogEntry('Profil sma≈æky naƒçten.', 'profile');
                }, 1000);
            }

            document.body.addEventListener('click', initializeAudio, { once: true });
            elements.scanButton.addEventListener('click', runScanSequence);
            elements.aiAnalysisButton.addEventListener('click', getThreatAnalysis);
            elements.profileButton.addEventListener('click', getSubjectProfile);
            elements.modalCloseButton.addEventListener('click', hideModal);
            elements.aiModal.addEventListener('click', (e) => { if(e.target === elements.aiModal) hideModal(); });

            function init() {
                changeSubject();
                createBlips();
                addLogEntry('Radar nastartovanej, syst√©m sjetej.', 'info');
                setInterval(createBlips, 5000);
                setInterval(updateThreatLevel, 8000);
                setInterval(tryRandomEvent, 15000); // Zkou≈°√≠ ud√°lost ka≈æd√Ωch 15s
                autoLogQuip();
            }
            init();
        });
    </script>
</body>
</html>